<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>Energy balance</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="icon.png"/></td>
    <td style="padding-left: 0.5em;">
    <div id="projectbrief">programmer&#39;s documentation</div>
    </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="cs_user_examples.html"><span>User&#160;examples</span></a></li>
      <li><a href="cs_var_dico.html"><span>Fortran-C&#160;naming&#160;reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="cs_user_examples.html">User examples</a></li><li class="navelem"><a class="el" href="cs_user_extra_operations_examples.html">cs_user_extra_operations.f90</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Energy balance </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="cs_user_extra_operations_examples_energy_balance"></a>
Energy balance</h1>
<h2><a class="anchor" id="cs_user_extra_operations_examples_loc_var_eb"></a>
Local variables to be added</h2>
<p>The following local variables need to be defined for the examples in this section:</p>
<div class="fragment"><div class="line"><span class="keywordtype">integer</span>          iel    , ifac   , ivar</div>
<div class="line"><span class="keywordtype">integer</span>          iel1   , iel2   , ieltsm</div>
<div class="line"><span class="keywordtype">integer</span>          iortho</div>
<div class="line"><span class="keywordtype">integer</span>          inc    , iccocg</div>
<div class="line"><span class="keywordtype">integer</span>          iflmas , iflmab , ipccp</div>
<div class="line"><span class="keywordtype">integer</span>          iscal</div>
<div class="line"><span class="keywordtype">integer</span>          ilelt  , nlelt</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">double precision</span> xvara  , xvar</div>
<div class="line"><span class="keywordtype">double precision</span> xbilan , xbilvl , xbilpa , xbilpt</div>
<div class="line"><span class="keywordtype">double precision</span> xbilsy , xbilen , xbilso , xbildv</div>
<div class="line"><span class="keywordtype">double precision</span> xbilmi , xbilma</div>
<div class="line"><span class="keywordtype">double precision</span> xfluxf , xgamma</div>
<div class="line"><span class="keywordtype">double precision</span> flumab , ctb1, ctb2</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">dimension(:)</span> :: lstelt</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">double precision</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">dimension(:,:)</span> :: grad</div>
<div class="line"><span class="keywordtype">double precision</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">dimension(:)</span> :: treco</div>
<div class="line"><span class="keywordtype">double precision</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">dimension(:)</span> :: xcp</div>
<div class="line"><span class="keywordtype">double precision</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">pointer</span> :: imasfl, bmasfl</div>
<div class="line"><span class="keywordtype">double precision</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">pointer</span> :: coefap, coefbp, cofafp, cofbfp</div>
<div class="line"><span class="keywordtype">double precision</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">pointer</span> ::  crom</div>
<div class="line"><span class="keywordtype">double precision</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">pointer</span> :: cpro_visct, cpro_cp</div>
<div class="line"><span class="keywordtype">double precision</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">pointer</span> :: cvar_scal, cvara_scal</div>
</div><!-- fragment --> <h2><a class="anchor" id="cs_user_extra_operations_examples_init"></a>
Initialization and finalization</h2>
<p>The following initialization block needs to be added for the following examples:</p>
<div class="fragment"><div class="line"><span class="comment">! Allocate a temporary array for cells or interior/boundary faces selection</span></div>
<div class="line"><span class="keyword">allocate</span>(lstelt(max(<a class="code" href="group__mesh.html#gab639b5ed89912ab852608e25d395a782">ncel</a>,<a class="code" href="group__mesh.html#ga984b4f9c95dbef7c83f0dee8bf4168a1">nfac</a>,<a class="code" href="group__mesh.html#gafd405a008e10defbfe94d267457278c5">nfabor</a>)))</div>
<div class="line"><span class="keyword">allocate</span>(xcp(<a class="code" href="group__mesh.html#gab639b5ed89912ab852608e25d395a782">ncel</a>))</div>
</div><!-- fragment --><p> Ad the end of the subroutine, it is recommended to deallocate the work array:</p>
<div class="fragment"><div class="line"><span class="comment">! Deallocate the temporary array</span></div>
<div class="line"><span class="keyword">deallocate</span>(lstelt)</div>
<div class="line"><span class="keyword">deallocate</span>(xcp)</div>
</div><!-- fragment --><p> In theory Fortran 95 deallocates locally-allocated arrays automatically, but deallocating arrays in a symmetric manner to their allocation is good practice, and it avoids using a different logic for C and Fortran.</p>
<h2><a class="anchor" id="cs_user_extra_operations_examples_eb_body"></a>
Body</h2>
<p>This example computes energy balance relative to temperature We assume that we want to compute balances (convective and diffusive) at the boundaries of the calculation domain represented below (with boundaries marked by colors).</p>
<p>The scalar considered if the temperature. We will also use the specific heat (to obtain balances in Joules)</p>
<p>Domain and associated boundary colors:</p><ul>
<li>2, 4, 7 : adiabatic walls</li>
<li>6 : wall with fixed temperature</li>
<li>3 : inlet</li>
<li>5 : outlet</li>
<li>1 : symmetry</li>
</ul>
<p>To ensure calculations have physical meaning, it is best to use a spatially uniform time step (<a class="el" href="group__time__step__options.html#ga3c439cb2b3e250cd8abc9e59c48ac12d">idtvar</a> = 0 or 1). In addition, when restarting a calculation, the balance is incorrect if <a class="el" href="group__time__step__options.html#gaa36cf7a7b611955f3c881171316468be">inpdt0</a>= 1 (visct not initialized and t(n-1) not known).</p>
<p>Temperature variable</p><ul>
<li>ivar = <a class="el" href="group__main__variables.html#isca">isca</a>(<a class="el" href="group__thermal.html#ga7bfe680df285604ff4e3e7a67ea0146e">iscalt</a>)</li>
</ul>
<p>Boundary coefficients coefap/coefbp are those of <a class="el" href="group__field__map.html#ga57aa6fc90649d0b34039aa88d2fec6f4">ivarfl</a>(ivar).</p>
<p>The balance at time step n is equal to:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \begin{array}{r c l} Balance^n &amp;=&amp; \displaystyle \sum_{\celli=1}^{\ncell} \norm{\vol{\celli}} C_p \rho_\celli \left(T_\celli^{n-1} -T_\celli^n \right) \\ &amp;+&amp; \displaystyle \sum_{\fib} C_p \Delta t_\celli \norm{\vect{S}_\ib} \left(A_\ib^f + B_\ib^f T_\celli^n \right) \\ &amp;+&amp; \displaystyle \sum_{\fib} C_p \Delta t_\celli \dot{m}_\ib \left(A_\ib^g + B_\ib^g T_\celli^n \right) \end{array} \]" src="form_525.png"/>
</p>
<p>The first term is negative if the amount of energy in the volume has increased (it is 0 in a steady regime).</p>
<p>The other terms (convection, diffusion) are positive if the amount of energy in the volume has increased due to boundary conditions.</p>
<p>In a steady regime, a positive balance thus indicates an energy gain.</p>
<p>With <img class="formulaInl" alt="$ \rho $" src="form_277.png"/> (<code>rom</code>) calculated using the density law from the <a class="el" href="cs__user__physical__properties_8f90.html#ae899ee735e815cfdcb46f0b50452a6da">usphyv</a> subroutine, for example:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \rho^{n-1}_\celli = P_0 / \left( R T_\celli^{n-1} + T_0 \right) \]" src="form_526.png"/>
</p>
<p> where <img class="formulaInl" alt="$ R$" src="form_527.png"/> is <code>rr</code> and <img class="formulaInl" alt="$ T_0 $" src="form_528.png"/> is <code>tkelv</code>.</p>
<p><img class="formulaInl" alt="$ C_p $" src="form_3.png"/> and <img class="formulaInl" alt="$ \lambda/C_p $" src="form_529.png"/> may vary.</p>
<p>Here is the corresponding code:</p>
<div class="fragment"><div class="line"><span class="comment">! The balance is not valid if inpdt0=1</span></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="group__time__step__options.html#gaa36cf7a7b611955f3c881171316468be">inpdt0</a>.eq.0) <span class="keywordflow">then</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! 2.1 Initialization</span></div>
<div class="line">  <span class="comment">! ==================</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! --&gt; Local variables</span></div>
<div class="line">  <span class="comment">!     ---------------</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! xbilvl: volume contribution of unsteady terms</span></div>
<div class="line">  <span class="comment">! xbildv: volume contribution due to to term in div(rho u)</span></div>
<div class="line">  <span class="comment">! xbilpa: contribution from adiabatic walls</span></div>
<div class="line">  <span class="comment">! xbilpt: contribution from walls with fixed temperature</span></div>
<div class="line">  <span class="comment">! xbilsy: contribution from symmetry boundaries</span></div>
<div class="line">  <span class="comment">! xbilen: contribution from inlets</span></div>
<div class="line">  <span class="comment">! xbilso: contribution from outlets</span></div>
<div class="line">  <span class="comment">! xbilmi: contribution from mass injections</span></div>
<div class="line">  <span class="comment">! xbilma: constribution from mass suctions</span></div>
<div class="line">  <span class="comment">! xbilan: total balance</span></div>
<div class="line"></div>
<div class="line">  xbilvl = 0.d0</div>
<div class="line">  xbildv = 0.d0</div>
<div class="line">  xbilpa = 0.d0</div>
<div class="line">  xbilpt = 0.d0</div>
<div class="line">  xbilsy = 0.d0</div>
<div class="line">  xbilen = 0.d0</div>
<div class="line">  xbilso = 0.d0</div>
<div class="line">  xbilmi = 0.d0</div>
<div class="line">  xbilma = 0.d0</div>
<div class="line">  xbilan = 0.d0</div>
<div class="line"></div>
<div class="line">  iscal = <a class="code" href="group__thermal.html#ga7bfe680df285604ff4e3e7a67ea0146e">iscalt</a>         <span class="comment">! temperature scalar number</span></div>
<div class="line">  ivar =  <a class="code" href="group__main__variables.html#ga2307b4d54b829b3aeeddf6c1e4e1129f">isca</a>(iscal)    <span class="comment">! temperature variable number</span></div>
<div class="line"></div>
<div class="line">  call <a class="code" href="classfield.html#a561d2e83a4150a004bb7798ade2cc000">field_get_val_s</a>(<a class="code" href="group__field__map.html#ga57aa6fc90649d0b34039aa88d2fec6f4">ivarfl</a>(ivar), cvar_scal)</div>
<div class="line">  call <a class="code" href="classfield.html#a7eb65512562d5475dc4281642f27767f">field_get_val_prev_s</a>(<a class="code" href="group__field__map.html#ga57aa6fc90649d0b34039aa88d2fec6f4">ivarfl</a>(ivar), cvara_scal)</div>
<div class="line"></div>
<div class="line">  <span class="comment">! Physical quantity numbers</span></div>
<div class="line">  call <a class="code" href="classfield.html#a561d2e83a4150a004bb7798ade2cc000">field_get_val_s</a>(<a class="code" href="group__physical__prop.html#gae1e1a9712ca7528170d028e64c29b74a">icrom</a>, crom)</div>
<div class="line">  call <a class="code" href="classfield.html#a561d2e83a4150a004bb7798ade2cc000">field_get_val_s</a>(<a class="code" href="group__field__map.html#gaf42a6fc4a9bb1a28a5b835afb9615c3d">iprpfl</a>(<a class="code" href="group__physical__prop.html#ga14630f3c0e0d1fcd83b31c27344d2287">ivisct</a>), cpro_visct)</div>
<div class="line"></div>
<div class="line">  <span class="comment">! Pointers to the mass fluxes</span></div>
<div class="line">  call <a class="code" href="classfield.html#a5f63f3fbe551d4076fa8123eff37363e">field_get_key_int</a>(<a class="code" href="group__field__map.html#ga57aa6fc90649d0b34039aa88d2fec6f4">ivarfl</a>(ivar), <a class="code" href="group__physical__prop.html#gacff9376a76700f96dec6c3ab15e57797">kimasf</a>, iflmas)</div>
<div class="line">  call <a class="code" href="classfield.html#a5f63f3fbe551d4076fa8123eff37363e">field_get_key_int</a>(<a class="code" href="group__field__map.html#ga57aa6fc90649d0b34039aa88d2fec6f4">ivarfl</a>(ivar), <a class="code" href="group__physical__prop.html#ga9e0fa60b417d1b321985ba34ef54c8fb">kbmasf</a>, iflmab)</div>
<div class="line">  call <a class="code" href="classfield.html#a561d2e83a4150a004bb7798ade2cc000">field_get_val_s</a>(iflmas, imasfl)</div>
<div class="line">  call <a class="code" href="classfield.html#a561d2e83a4150a004bb7798ade2cc000">field_get_val_s</a>(iflmab, bmasfl)</div>
<div class="line"></div>
<div class="line">  <span class="comment">! The balance is in Joule, so store the specific heat when dealing</span></div>
<div class="line">  <span class="comment">! with the Temperature.</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="group__physical__prop.html#gafbdcaf999c072e2bad96f5c08686c63d">icp</a>.gt.0) call <a class="code" href="classfield.html#a561d2e83a4150a004bb7798ade2cc000">field_get_val_s</a>(<a class="code" href="group__field__map.html#gaf42a6fc4a9bb1a28a5b835afb9615c3d">iprpfl</a>(<a class="code" href="group__physical__prop.html#gafbdcaf999c072e2bad96f5c08686c63d">icp</a>), cpro_cp)</div>
<div class="line"></div>
<div class="line">  <span class="comment">! If it is a temperature</span></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="group__thermal.html#gaf7ab0215a4d902590e17b4a4796244e0">itherm</a>.eq.1) <span class="keywordflow">then</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__physical__prop.html#gafbdcaf999c072e2bad96f5c08686c63d">icp</a>.gt.0) <span class="keywordflow">then</span></div>
<div class="line">      <span class="keywordflow">do</span> iel = 1, <a class="code" href="group__mesh.html#gab639b5ed89912ab852608e25d395a782">ncel</a></div>
<div class="line">        xcp(iel) = cpro_cp(iel)</div>
<div class="line">      <span class="keywordflow">enddo</span></div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      <span class="keywordflow">do</span> iel = 1, <a class="code" href="group__mesh.html#gab639b5ed89912ab852608e25d395a782">ncel</a></div>
<div class="line">        xcp(iel) = <a class="code" href="group__cstphy.html#ga58f2f69a0623a8b2574a3b87af07d30e">cp0</a></div>
<div class="line">      <span class="keywordflow">enddo</span></div>
<div class="line">    <span class="keywordflow">endif</span></div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    <span class="keywordflow">do</span> iel = 1, <a class="code" href="group__mesh.html#gab639b5ed89912ab852608e25d395a782">ncel</a></div>
<div class="line">      xcp(iel) = 1.d0</div>
<div class="line">    <span class="keywordflow">enddo</span></div>
<div class="line">  <span class="keywordflow">endif</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! Boundary condition pointers for gradients and advection</span></div>
<div class="line"></div>
<div class="line">  call <a class="code" href="classfield.html#a11e96cf8c5dd0e7d123d48ec4bf7b98b">field_get_coefa_s</a>(<a class="code" href="group__field__map.html#ga57aa6fc90649d0b34039aa88d2fec6f4">ivarfl</a>(ivar), coefap)</div>
<div class="line">  call <a class="code" href="classfield.html#a974abb77c62726933ac4252054982343">field_get_coefb_s</a>(<a class="code" href="group__field__map.html#ga57aa6fc90649d0b34039aa88d2fec6f4">ivarfl</a>(ivar), coefbp)</div>
<div class="line"></div>
<div class="line">  <span class="comment">! Boundary condition pointers for diffusion</span></div>
<div class="line"></div>
<div class="line">  call <a class="code" href="classfield.html#a543a580c6ccb0c0ef9eb7de27dba874a">field_get_coefaf_s</a>(<a class="code" href="group__field__map.html#ga57aa6fc90649d0b34039aa88d2fec6f4">ivarfl</a>(ivar), cofafp)</div>
<div class="line">  call <a class="code" href="classfield.html#a16957eed0dcfd80c91f6dab259a273e4">field_get_coefbf_s</a>(<a class="code" href="group__field__map.html#ga57aa6fc90649d0b34039aa88d2fec6f4">ivarfl</a>(ivar), cofbfp)</div>
<div class="line"></div>
<div class="line">  <span class="comment">! --&gt; Compute value reconstructed at I&#39; for boundary faces</span></div>
<div class="line"></div>
<div class="line">  <span class="keyword">allocate</span>(treco(<a class="code" href="group__mesh.html#gafd405a008e10defbfe94d267457278c5">nfabor</a>))</div>
<div class="line"></div>
<div class="line">  <span class="comment">! For non-orthogonal meshes, it must be equal to the value at the</span></div>
<div class="line">  <span class="comment">! cell center, which is computed in:</span></div>
<div class="line">  <span class="comment">! treco(ifac) (with ifac=1, nfabor)</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! For orthogonal meshes, it is sufficient to assign:</span></div>
<div class="line">  <span class="comment">! cvar_scal(iel) to treco(ifac), with iel=ifabor(ifac)</span></div>
<div class="line">  <span class="comment">! (this option corresponds to the second branch of the test below,</span></div>
<div class="line">  <span class="comment">! with iortho different from 0).</span></div>
<div class="line"></div>
<div class="line">  iortho = 0</div>
<div class="line"></div>
<div class="line">  <span class="comment">! --&gt; General case (for non-orthogonal meshes)</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (iortho.eq.0) <span class="keywordflow">then</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">! Allocate a work array for the gradient calculation</span></div>
<div class="line">    <span class="keyword">allocate</span>(grad(3,<a class="code" href="group__mesh.html#ga639172a5bdf2c9669ddeab06a362b992">ncelet</a>))</div>
<div class="line"></div>
<div class="line">    <span class="comment">! --- Compute temperature gradient</span></div>
<div class="line"></div>
<div class="line">    inc = 1</div>
<div class="line">    iccocg = 1</div>
<div class="line"></div>
<div class="line">    call <a class="code" href="interfacefield__operator_1_1field__gradient__scalar.html#aa43d96cf868d52e6e04d47301847acc7">field_gradient_scalar</a> &amp;</div>
<div class="line">    <span class="comment">!=========================</span></div>
<div class="line">      (<a class="code" href="group__field__map.html#ga57aa6fc90649d0b34039aa88d2fec6f4">ivarfl</a>(ivar), 0, <a class="code" href="group__gradient__calculation.html#ga50d456a39f909fd69848a0f9b6c80cbc">imrgra</a>, inc, iccocg,                               &amp;</div>
<div class="line">       grad)</div>
<div class="line"></div>
<div class="line">    <span class="comment">! - Compute reconstructed value in boundary cells</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">do</span> ifac = 1, <a class="code" href="group__mesh.html#gafd405a008e10defbfe94d267457278c5">nfabor</a></div>
<div class="line">      iel = <a class="code" href="group__mesh.html#ga0d1cf9f4d3d0b6219ac4c4bda4797470">ifabor</a>(ifac)</div>
<div class="line">      treco(ifac) =   cvar_scal(iel)       &amp;</div>
<div class="line">                    + <a class="code" href="group__mesh.html#ga59173fc5c93d7aa132b8a7f2a0e03ba3">diipb</a>(1,ifac)*grad(1,iel)  &amp;</div>
<div class="line">                    + <a class="code" href="group__mesh.html#ga59173fc5c93d7aa132b8a7f2a0e03ba3">diipb</a>(2,ifac)*grad(2,iel)  &amp;</div>
<div class="line">                    + <a class="code" href="group__mesh.html#ga59173fc5c93d7aa132b8a7f2a0e03ba3">diipb</a>(3,ifac)*grad(3,iel)</div>
<div class="line">    <span class="keywordflow">enddo</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">! Free memory</span></div>
<div class="line">    <span class="keyword">deallocate</span>(grad)</div>
<div class="line"></div>
<div class="line">  <span class="comment">! --&gt; Case of orthogonal meshes</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">! Compute reconstructed value</span></div>
<div class="line">    <span class="comment">! (here, we assign the non-reconstructed value)</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">do</span> ifac = 1, <a class="code" href="group__mesh.html#gafd405a008e10defbfe94d267457278c5">nfabor</a></div>
<div class="line">      iel = <a class="code" href="group__mesh.html#ga0d1cf9f4d3d0b6219ac4c4bda4797470">ifabor</a>(ifac)</div>
<div class="line">      treco(ifac) = cvar_scal(iel)</div>
<div class="line">    <span class="keywordflow">enddo</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">endif</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! 2.1 Compute the balance at time step n</span></div>
<div class="line">  <span class="comment">! ======================================</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! --&gt; Balance on interior volumes</span></div>
<div class="line">  <span class="comment">!     ---------------------------</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! If it is variable, the density &#39;rom&#39; has been computed at the beginning</span></div>
<div class="line">  <span class="comment">! of the time step using the temperature from the previous time step.</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">do</span> iel = 1, <a class="code" href="group__mesh.html#gab639b5ed89912ab852608e25d395a782">ncel</a></div>
<div class="line">    xvara = cvara_scal(iel)</div>
<div class="line">    xvar  = cvar_scal(iel)</div>
<div class="line">    xbilvl =   xbilvl                              &amp;</div>
<div class="line">             + <a class="code" href="group__mesh.html#ga63281eee444c94c800bc957891033901">volume</a>(iel) * xcp(iel) * crom(iel)  &amp;</div>
<div class="line">                           * (xvara - xvar)</div>
<div class="line">  <span class="keywordflow">enddo</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! --&gt; Balance on all faces (interior and boundary), for div(rho u)</span></div>
<div class="line">  <span class="comment">!     ------------------------------------------------------------</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">do</span> ifac = 1, <a class="code" href="group__mesh.html#ga984b4f9c95dbef7c83f0dee8bf4168a1">nfac</a></div>
<div class="line"></div>
<div class="line">    iel1 = <a class="code" href="group__mesh.html#ga130a63093e80370693976655259c8335">ifacel</a>(1,ifac)</div>
<div class="line">    <span class="keywordflow">if</span> (iel1.le.<a class="code" href="group__mesh.html#gab639b5ed89912ab852608e25d395a782">ncel</a>) <span class="keywordflow">then</span></div>
<div class="line">      ctb1 = imasfl(ifac)*xcp(iel1)*cvar_scal(iel1)*<a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel1)</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      ctb1 = 0d0</div>
<div class="line">    <span class="keywordflow">endif</span></div>
<div class="line"></div>
<div class="line">    iel2 = <a class="code" href="group__mesh.html#ga130a63093e80370693976655259c8335">ifacel</a>(2,ifac)</div>
<div class="line">    <span class="keywordflow">if</span> (iel2.le.<a class="code" href="group__mesh.html#gab639b5ed89912ab852608e25d395a782">ncel</a>) <span class="keywordflow">then</span></div>
<div class="line">      ctb2 = imasfl(ifac)*xcp(iel2)*cvar_scal(iel2)*<a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel2)</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      ctb2 = 0d0</div>
<div class="line">    <span class="keywordflow">endif</span></div>
<div class="line"></div>
<div class="line">    xbildv =  xbildv + (ctb1 - ctb2)</div>
<div class="line">  <span class="keywordflow">enddo</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">do</span> ifac = 1, <a class="code" href="group__mesh.html#gafd405a008e10defbfe94d267457278c5">nfabor</a></div>
<div class="line">    iel = <a class="code" href="group__mesh.html#ga0d1cf9f4d3d0b6219ac4c4bda4797470">ifabor</a>(ifac)</div>
<div class="line">    xbildv = xbildv + <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel) * xcp(iel)             &amp;</div>
<div class="line">                              * bmasfl(ifac)         &amp;</div>
<div class="line">                              * cvar_scal(iel)</div>
<div class="line">  <span class="keywordflow">enddo</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">! In case of a mass source term, add contribution from Gamma*Tn+1</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="group__auxiliary.html#ga66be6a7f558fc7af1eab0091ad40dad9">ncetsm</a>.gt.0) <span class="keywordflow">then</span></div>
<div class="line">    <span class="keywordflow">do</span> ieltsm = 1, <a class="code" href="group__auxiliary.html#ga66be6a7f558fc7af1eab0091ad40dad9">ncetsm</a></div>
<div class="line">      iel = <a class="code" href="group__auxiliary.html#gabf7912f7a1d1a977430bd0e6de910c00">icetsm</a>(ieltsm)</div>
<div class="line">      xvar  = cvar_scal(iel)</div>
<div class="line">      xgamma = <a class="code" href="group__auxiliary.html#ga44665e060ed56962486419027016c32e">smacel</a>(ieltsm,<a class="code" href="group__main__variables.html#gad6a04316c3de6fdce7585d9847515b8a">ipr</a>)</div>
<div class="line">      xbildv =   xbildv                            &amp;</div>
<div class="line">               - <a class="code" href="group__mesh.html#ga63281eee444c94c800bc957891033901">volume</a>(iel) * xcp(iel) * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel)  &amp;</div>
<div class="line">                             * xgamma * xvar</div>
<div class="line">    <span class="keywordflow">enddo</span></div>
<div class="line">  <span class="keywordflow">endif</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! --&gt; Balance on boundary faces</span></div>
<div class="line">  <span class="comment">!     -------------------------</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! We handle different types of boundary faces separately to better</span></div>
<div class="line">  <span class="comment">! analyze the information, but this is not mandatory.</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! - Compute the contribution from walls with colors 2, 4, and 7</span></div>
<div class="line">  <span class="comment">!   (adiabatic here, so flux should be 0)</span></div>
<div class="line"></div>
<div class="line">  call <a class="code" href="cs__selector__f2c_8f90.html#a15b3c47b14d96445222d40944aa0d6e1">getfbr</a>(<span class="stringliteral">&#39;2 or 4 or 7&#39;</span>, nlelt, lstelt)</div>
<div class="line">  <span class="comment">!==========</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">do</span> ilelt = 1, nlelt</div>
<div class="line"></div>
<div class="line">    ifac = lstelt(ilelt)</div>
<div class="line">    iel  = <a class="code" href="group__mesh.html#ga0d1cf9f4d3d0b6219ac4c4bda4797470">ifabor</a>(ifac)   <span class="comment">! associated boundary cell</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">! Physical variables</span></div>
<div class="line"></div>
<div class="line">    flumab = bmasfl(ifac)</div>
<div class="line"></div>
<div class="line">    <span class="comment">! Contribution to flux from the current face</span></div>
<div class="line">    <span class="comment">! (diffusion and convection flux, negative if incoming)</span></div>
<div class="line"></div>
<div class="line">    xfluxf = - <a class="code" href="group__mesh.html#ga8c334f6ec151c5c1545282a6726d335e">surfbn</a>(ifac) * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel)                       &amp;</div>
<div class="line">             * (cofafp(ifac) + cofbfp(ifac)*treco(ifac))    &amp;</div>
<div class="line">           - flumab * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel) * xcp(iel)                    &amp;</div>
<div class="line">             * (coefap(ifac) + coefbp(ifac)*treco(ifac))</div>
<div class="line"></div>
<div class="line">    xbilpa = xbilpa + xfluxf</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">enddo</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! Contribution from walls with color 6</span></div>
<div class="line">  <span class="comment">! (here at fixed temperature; the convective flux should be 0)</span></div>
<div class="line"></div>
<div class="line">  call <a class="code" href="cs__selector__f2c_8f90.html#a15b3c47b14d96445222d40944aa0d6e1">getfbr</a>(<span class="stringliteral">&#39;6&#39;</span>, nlelt, lstelt)</div>
<div class="line">  <span class="comment">!==========</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">do</span> ilelt = 1, nlelt</div>
<div class="line"></div>
<div class="line">    ifac = lstelt(ilelt)</div>
<div class="line">    iel  = <a class="code" href="group__mesh.html#ga0d1cf9f4d3d0b6219ac4c4bda4797470">ifabor</a>(ifac)   <span class="comment">! associated boundary cell</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">! Physical variables</span></div>
<div class="line"></div>
<div class="line">    flumab = bmasfl(ifac)</div>
<div class="line"></div>
<div class="line">    <span class="comment">! Contribution to flux from the current face</span></div>
<div class="line">    <span class="comment">! (diffusion and convection flux, negative if incoming)</span></div>
<div class="line"></div>
<div class="line">    xfluxf = - <a class="code" href="group__mesh.html#ga8c334f6ec151c5c1545282a6726d335e">surfbn</a>(ifac) * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel)                       &amp;</div>
<div class="line">             * (cofafp(ifac) + cofbfp(ifac)*treco(ifac))    &amp;</div>
<div class="line">           - flumab * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel) * xcp(iel)                    &amp;</div>
<div class="line">             * (coefap(ifac) + coefbp(ifac)*treco(ifac))</div>
<div class="line"></div>
<div class="line">    xbilpt = xbilpt + xfluxf</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">enddo</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! Contribution from symmetries (should be 0).</span></div>
<div class="line"></div>
<div class="line">  call <a class="code" href="cs__selector__f2c_8f90.html#a15b3c47b14d96445222d40944aa0d6e1">getfbr</a>(<span class="stringliteral">&#39;1&#39;</span>, nlelt, lstelt)</div>
<div class="line">  <span class="comment">!==========</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">do</span> ilelt = 1, nlelt</div>
<div class="line"></div>
<div class="line">    ifac = lstelt(ilelt)</div>
<div class="line">    iel  = <a class="code" href="group__mesh.html#ga0d1cf9f4d3d0b6219ac4c4bda4797470">ifabor</a>(ifac)   <span class="comment">! associated boundary cell</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">! Physical variables</span></div>
<div class="line"></div>
<div class="line">    flumab = bmasfl(ifac)</div>
<div class="line"></div>
<div class="line">    <span class="comment">! Contribution to flux from the current face</span></div>
<div class="line">    <span class="comment">! (diffusion and convection flux, negative if incoming)</span></div>
<div class="line"></div>
<div class="line">    xfluxf = - <a class="code" href="group__mesh.html#ga8c334f6ec151c5c1545282a6726d335e">surfbn</a>(ifac) * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel)                       &amp;</div>
<div class="line">             * (cofafp(ifac) + cofbfp(ifac)*treco(ifac))    &amp;</div>
<div class="line">           - flumab * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel) * xcp(iel)                    &amp;</div>
<div class="line">             * (coefap(ifac) + coefbp(ifac)*treco(ifac))</div>
<div class="line"></div>
<div class="line">    xbilsy = xbilsy + xfluxf</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">enddo</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! Contribution from inlet (color 3, diffusion and convection flux)</span></div>
<div class="line"></div>
<div class="line">  call <a class="code" href="cs__selector__f2c_8f90.html#a15b3c47b14d96445222d40944aa0d6e1">getfbr</a>(<span class="stringliteral">&#39;3&#39;</span>, nlelt, lstelt)</div>
<div class="line">  <span class="comment">!==========</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">do</span> ilelt = 1, nlelt</div>
<div class="line"></div>
<div class="line">    ifac = lstelt(ilelt)</div>
<div class="line">    iel  = <a class="code" href="group__mesh.html#ga0d1cf9f4d3d0b6219ac4c4bda4797470">ifabor</a>(ifac)   <span class="comment">! associated boundary cell</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">! Physical variables</span></div>
<div class="line"></div>
<div class="line">    flumab = bmasfl(ifac)</div>
<div class="line"></div>
<div class="line">    <span class="comment">! Contribution to flux from the current face</span></div>
<div class="line">    <span class="comment">! (diffusion and convection flux, negative if incoming)</span></div>
<div class="line"></div>
<div class="line">    xfluxf = - <a class="code" href="group__mesh.html#ga8c334f6ec151c5c1545282a6726d335e">surfbn</a>(ifac) * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel)                       &amp;</div>
<div class="line">             * (cofafp(ifac) + cofbfp(ifac)*treco(ifac))    &amp;</div>
<div class="line">           - flumab * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel) * xcp(iel)                    &amp;</div>
<div class="line">             * (coefap(ifac) + coefbp(ifac)*treco(ifac))</div>
<div class="line"></div>
<div class="line">    xbilen = xbilen + xfluxf</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">enddo</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! Contribution from outlet (color 5, diffusion and convection flux)</span></div>
<div class="line"></div>
<div class="line">  call <a class="code" href="cs__selector__f2c_8f90.html#a15b3c47b14d96445222d40944aa0d6e1">getfbr</a>(<span class="stringliteral">&#39;5&#39;</span>, nlelt, lstelt)</div>
<div class="line">  <span class="comment">!==========</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">do</span> ilelt = 1, nlelt</div>
<div class="line"></div>
<div class="line">    ifac = lstelt(ilelt)</div>
<div class="line">    iel  = <a class="code" href="group__mesh.html#ga0d1cf9f4d3d0b6219ac4c4bda4797470">ifabor</a>(ifac)   <span class="comment">! associated boundary cell</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">! Physical variables</span></div>
<div class="line"></div>
<div class="line">    flumab = bmasfl(ifac)</div>
<div class="line"></div>
<div class="line">    <span class="comment">! Contribution to flux from the current face</span></div>
<div class="line">    <span class="comment">! (diffusion and convection flux, negative if incoming)</span></div>
<div class="line"></div>
<div class="line">    xfluxf = - <a class="code" href="group__mesh.html#ga8c334f6ec151c5c1545282a6726d335e">surfbn</a>(ifac) * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel)                       &amp;</div>
<div class="line">             * (cofafp(ifac) + cofbfp(ifac)*treco(ifac))    &amp;</div>
<div class="line">           - flumab * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel) * xcp(iel)                    &amp;</div>
<div class="line">             * (coefap(ifac) + coefbp(ifac)*treco(ifac))</div>
<div class="line"></div>
<div class="line">    xbilso = xbilso + xfluxf</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">enddo</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! Now the work array for the temperature can be freed</span></div>
<div class="line">  <span class="keyword">deallocate</span>(treco)</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">! --&gt; Balance on mass source terms</span></div>
<div class="line">  <span class="comment">!     ----------------------------</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! We separate mass injections from suctions for better generality</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="group__auxiliary.html#ga66be6a7f558fc7af1eab0091ad40dad9">ncetsm</a>.gt.0) <span class="keywordflow">then</span></div>
<div class="line">    <span class="keywordflow">do</span> ieltsm = 1, <a class="code" href="group__auxiliary.html#ga66be6a7f558fc7af1eab0091ad40dad9">ncetsm</a></div>
<div class="line">      <span class="comment">! depending on the type of injection we use the &#39;smacell&#39; value</span></div>
<div class="line">      <span class="comment">! or the ambient temperature</span></div>
<div class="line">      iel = <a class="code" href="group__auxiliary.html#gabf7912f7a1d1a977430bd0e6de910c00">icetsm</a>(ieltsm)</div>
<div class="line">      xgamma = <a class="code" href="group__auxiliary.html#ga44665e060ed56962486419027016c32e">smacel</a>(ieltsm,<a class="code" href="group__main__variables.html#gad6a04316c3de6fdce7585d9847515b8a">ipr</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="group__auxiliary.html#gab2d40a208a57b9db84839709dca4fd1f">itypsm</a>(ieltsm,ivar).eq.0 .or. xgamma.lt.0.d0) <span class="keywordflow">then</span></div>
<div class="line">        xvar = cvar_scal(iel)</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        xvar = <a class="code" href="group__auxiliary.html#ga44665e060ed56962486419027016c32e">smacel</a>(ieltsm,ivar)</div>
<div class="line">      <span class="keywordflow">endif</span></div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="group__physical__prop.html#gafbdcaf999c072e2bad96f5c08686c63d">icp</a>.gt.0) <span class="keywordflow">then</span></div>
<div class="line">        <span class="keywordflow">if</span> (xgamma.lt.0.d0) <span class="keywordflow">then</span></div>
<div class="line">          xbilma =   xbilma  &amp;</div>
<div class="line">                   + <a class="code" href="group__mesh.html#ga63281eee444c94c800bc957891033901">volume</a>(iel) * cpro_cp(iel) * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel) * xgamma * xvar</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          xbilmi =   xbilmi  &amp;</div>
<div class="line">                   + <a class="code" href="group__mesh.html#ga63281eee444c94c800bc957891033901">volume</a>(iel) * cpro_cp(iel) * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel) * xgamma * xvar</div>
<div class="line">        <span class="keywordflow">endif</span></div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">if</span> (xgamma.lt.0.d0) <span class="keywordflow">then</span></div>
<div class="line">          xbilma =   xbilma  &amp;</div>
<div class="line">                   + <a class="code" href="group__mesh.html#ga63281eee444c94c800bc957891033901">volume</a>(iel) * <a class="code" href="group__cstphy.html#ga58f2f69a0623a8b2574a3b87af07d30e">cp0</a> * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel) * xgamma * xvar</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          xbilmi =   xbilmi  &amp;</div>
<div class="line">                   + <a class="code" href="group__mesh.html#ga63281eee444c94c800bc957891033901">volume</a>(iel) * <a class="code" href="group__cstphy.html#ga58f2f69a0623a8b2574a3b87af07d30e">cp0</a> * <a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00ace72dfc61c6b4eec681c484e0afa7474">dt</a>(iel) * xgamma * xvar</div>
<div class="line">        <span class="keywordflow">endif</span></div>
<div class="line">      <span class="keywordflow">endif</span></div>
<div class="line">    <span class="keywordflow">enddo</span></div>
<div class="line">  <span class="keywordflow">endif</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! Sum of values on all ranks (parallel calculations)</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="group__parall.html#ga77fe56a9acf4fc4a56b5d5ab878b7d4f">irangp</a>.ge.0) <span class="keywordflow">then</span></div>
<div class="line">    call <a class="code" href="interfaceparall_1_1parsom.html#a424406b4b54d67ae738db5ab55be7119">parsom</a>(xbilvl)</div>
<div class="line">    call <a class="code" href="interfaceparall_1_1parsom.html#a424406b4b54d67ae738db5ab55be7119">parsom</a>(xbildv)</div>
<div class="line">    call <a class="code" href="interfaceparall_1_1parsom.html#a424406b4b54d67ae738db5ab55be7119">parsom</a>(xbilpa)</div>
<div class="line">    call <a class="code" href="interfaceparall_1_1parsom.html#a424406b4b54d67ae738db5ab55be7119">parsom</a>(xbilpt)</div>
<div class="line">    call <a class="code" href="interfaceparall_1_1parsom.html#a424406b4b54d67ae738db5ab55be7119">parsom</a>(xbilsy)</div>
<div class="line">    call <a class="code" href="interfaceparall_1_1parsom.html#a424406b4b54d67ae738db5ab55be7119">parsom</a>(xbilen)</div>
<div class="line">    call <a class="code" href="interfaceparall_1_1parsom.html#a424406b4b54d67ae738db5ab55be7119">parsom</a>(xbilso)</div>
<div class="line">    call <a class="code" href="interfaceparall_1_1parsom.html#a424406b4b54d67ae738db5ab55be7119">parsom</a>(xbilmi)</div>
<div class="line">    call <a class="code" href="interfaceparall_1_1parsom.html#a424406b4b54d67ae738db5ab55be7119">parsom</a>(xbilma)</div>
<div class="line">  <span class="keywordflow">endif</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! --&gt; Total balance</span></div>
<div class="line">  <span class="comment">!     -------------</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">! We add the different contributions calculated above.</span></div>
<div class="line"></div>
<div class="line">  xbilan =   xbilvl + xbildv + xbilpa + xbilpt + xbilsy + xbilen   &amp;</div>
<div class="line">           + xbilso + xbilmi + xbilma</div>
<div class="line"></div>
<div class="line">  <span class="comment">! 2.3 Write the balance at time step n</span></div>
<div class="line">  <span class="comment">! ====================================</span></div>
<div class="line"></div>
<div class="line">  <span class="keyword">write</span> (<a class="code" href="group__entsor.html#ga35356a73490ee90d10e4a96684169505">nfecra</a>, 2000)                                               &amp;</div>
<div class="line">    <a class="code" href="group__time__step__options.html#ga8893d91edb2d95d49bfeadfe9a3b12db">ntcabs</a>, xbilvl, xbildv, xbilpa, xbilpt, xbilsy, xbilen, xbilso,  &amp;</div>
<div class="line">    xbilmi, xbilma, xbilan</div>
<div class="line"></div>
<div class="line">2000 <span class="keyword">format</span>                                                           &amp;</div>
<div class="line">  (/,                                                                 &amp;</div>
<div class="line">   3x,<span class="stringliteral">&#39;** Thermal balance **&#39;</span>, /,                                     &amp;</div>
<div class="line">   3x,<span class="stringliteral">&#39;   ---------------&#39;</span>, /,                                        &amp;</div>
<div class="line">   <span class="stringliteral">&#39;---&#39;</span>, <span class="stringliteral">&#39;------&#39;</span>,                                                   &amp;</div>
<div class="line">   <span class="stringliteral">&#39;------------------------------------------------------------&#39;</span>, /, &amp;</div>
<div class="line">   <span class="stringliteral">&#39;bt &#39;</span>,<span class="stringliteral">&#39;  Iter&#39;</span>,                                                    &amp;</div>
<div class="line">   <span class="stringliteral">&#39;   Volume     Divergence  Adia Wall   Fixed_T Wall  Symmetry&#39;</span>,    &amp;</div>
<div class="line">   <span class="stringliteral">&#39;      Inlet       Outlet  Inj. Mass.  Suc. Mass.  Total&#39;</span>, /,      &amp;</div>
<div class="line">   <span class="stringliteral">&#39;bt &#39;</span>, i6, 10e12.4, /,                                             &amp;</div>
<div class="line">   <span class="stringliteral">&#39;---&#39;</span>,<span class="stringliteral">&#39;------&#39;</span>,                                                    &amp;</div>
<div class="line">   <span class="stringliteral">&#39;------------------------------------------------------------&#39;</span>)</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">endif</span> <span class="comment">! End of test on inpdt0</span></div>
</div><!-- fragment --></div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Apr 6 2016 17:20:36 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
