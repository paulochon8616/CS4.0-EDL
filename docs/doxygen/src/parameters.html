<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>Input of calculation parameters (C functions)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="icon.png"/></td>
    <td style="padding-left: 0.5em;">
    <div id="projectbrief">programmer&#39;s documentation</div>
    </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="cs_user_examples.html"><span>User&#160;examples</span></a></li>
      <li><a href="cs_var_dico.html"><span>Fortran-C&#160;naming&#160;reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="cs_user_examples.html">User examples</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Input of calculation parameters (C functions) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="cs_user_parameters_h_intro"></a>
Introduction</h1>
<p>C user functions for definition of model options and calculation parameters. These subroutines are called in all cases.</p>
<p>If the Code_Saturne GUI is used, this file is not required (but may be used to override parameters entered through the GUI, and to set parameters not accessible through the GUI).</p>
<p>Several functions are present in the file, each destined to defined specific parameters.</p>
<h1><a class="anchor" id="cs_user_parameters_h_cs_user_model"></a>
Base model related options</h1>
<p>Definition of user variables or properties should be defined here, if not already done throught the GUI.</p>
<h1><a class="anchor" id="cs_user_parameters_h_cs_user_linear_solvers"></a>
Linear solver related options</h1>
<p>By default, Code_Saturne will use a multigrid algorithm for pressure and iterative solver for other variables. For a given case, checking the setup file resulting from a first calculation will provide more info.</p>
<p>Available solvers include a variety of iterative linear solvers, described in more detail at <a class="el" href="cs__sles__it_8h.html#a442df738ae0b765b9ce3ad2ac51ea7ae">cs_sles_it_create</a>, and a multigrid solver, whose definition and settings are described at <a class="el" href="cs__multigrid_8h.html#ae2ffd9a61f45447b2fa3ca1b7abced7a">cs_multigrid_create</a>, <a class="el" href="cs__multigrid_8h.html#ac51079525d670ca86bd36dcce16fa46b">cs_multigrid_set_coarsening_options</a>, and <a class="el" href="cs__multigrid_8h.html#aa3fcf31a4edfc5d849804b9e0b137c3e">cs_multigrid_set_solver_options</a>.</p>
<p>Simple options may be set using the GUI, but for more advanced settings are described in this section. It is also recommended to read the documentation of <a class="el" href="cs__sles_8c.html">cs_sles.c</a> (which is a solver definition "container"), <a class="el" href="cs__sles__it_8c.html">cs_sles_it.c</a> (iterative solvers, with available types <a class="el" href="cs__sles__it_8h.html#ade7660f2d21b046b7883ae7ae454d535">cs_sles_it_type_t</a>), and <a class="el" href="cs__multigrid_8c.html">cs_multigrid.c</a> (which are actual solver implementations). The API provided is extensible, so it is possible for a user to define other solvers or link to external solver libraries using this system, without requiring any modification to non-user source files.</p>
<p>The examples which follow illustrate mostly simple setting changes which may be useful.</p>
<h2><a class="anchor" id="cs_user_parameters_h_sles_ex_1"></a>
Example: distance to wall</h2>
<p>By default, the wall distance (active only with turbulence models which require it) is computed with a preconditionned conjugate gradient. The following example shows how to use a multigrid solver for this quantity (useful especially if computed repeatedly, such as for ALE).</p>
<div class="fragment"><div class="line">  <a class="code" href="cs__multigrid_8c.html#a5034eddfde4e8320c6c970aafd1e369d">cs_multigrid_define</a>(-1, <span class="stringliteral">&quot;wall_distance&quot;</span>);</div>
</div><!-- fragment --> <h2><a class="anchor" id="cs_user_parameters_h_sles_user_1"></a>
Example: user variable</h2>
<p>The following example shows how to set the linear solver for a given user variable field so as to use a BiCGStab solver with polynomial preconditioning of degree 1.</p>
<div class="fragment"><div class="line">  <a class="code" href="structcs__field__t.html">cs_field_t</a> *cvar_user_1 = <a class="code" href="cs__field_8c.html#a269af9bd82585bc7a85c810055f1be22">cs_field_by_name_try</a>(<span class="stringliteral">&quot;user_1&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (cvar_user_1 != NULL) {</div>
<div class="line">    <a class="code" href="cs__sles__it_8c.html#a64c4f431048a0436cf67314c01883fdc">cs_sles_it_define</a>(cvar_user_1-&gt;<a class="code" href="structcs__field__t.html#acf2488b95c97e0378c9bf49de3b50f28">id</a>,</div>
<div class="line">                      NULL,   <span class="comment">/* name passed is NULL if field_id &gt; -1 */</span></div>
<div class="line">                      <a class="code" href="cs__sles__it_8h.html#ade7660f2d21b046b7883ae7ae454d535a74a5b83b4daf020337a3dfb47197d182">CS_SLES_BICGSTAB2</a>,</div>
<div class="line">                      1,      <span class="comment">/*  polynomial precond. degree (default 0) */</span></div>
<div class="line">                      10000); <span class="comment">/* n_max_iter */</span></div>
<div class="line">  }</div>
</div><!-- fragment --> <h2><a class="anchor" id="cs_user_parameters_h_sles_verbosity_1"></a>
Changing the verbosity</h2>
<p>By default, a linear solver uses the same verbosity as its matching variable, and is not verbose for non-variable quantities. The verbosity may be specifically set for linear system resolution, as shown in the following example:</p>
<div class="fragment"><div class="line"></div>
<div class="line">  <a class="code" href="cs__sles_8h.html#aed772500d289d10070362ccee256864c">cs_sles_t</a> *sles_p = <a class="code" href="cs__sles_8c.html#a421a687486db9b36d49031e36512ae16">cs_sles_find_or_add</a>(<a class="code" href="cs__field__pointer_8h.html#ae1781f0372dce86ddbc097c119dfd028">CS_F_</a>(<a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00a188032b3e6837794e08d485d4426f1bb">p</a>)-&gt;<span class="keywordtype">id</span>, NULL);</div>
<div class="line">  <a class="code" href="cs__sles_8c.html#a858d1660d79dd1c728a74a15de6f54ed">cs_sles_set_verbosity</a>(sles_p, 4);</div>
<div class="line"></div>
</div><!-- fragment --> <h2><a class="anchor" id="cs_user_parameters_h_sles_mgp_1"></a>
Example: advanced multigrid settings</h2>
<p>The following example shows how to set advanced settings for the multigrid solver used for the pressure solution.</p>
<div class="fragment"><div class="line">  <a class="code" href="cs__multigrid_8h.html#a20ba2184cfbebea6a7afaf39591bcb9c">cs_multigrid_t</a> *mg = <a class="code" href="cs__multigrid_8c.html#a5034eddfde4e8320c6c970aafd1e369d">cs_multigrid_define</a>(<a class="code" href="cs__field__pointer_8h.html#ae1781f0372dce86ddbc097c119dfd028">CS_F_</a>(<a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00a188032b3e6837794e08d485d4426f1bb">p</a>)-&gt;<span class="keywordtype">id</span>, NULL);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="cs__multigrid_8c.html#a14b513c634d86c2aa012c726d24916dc">cs_multigrid_set_coarsening_options</a>(mg,</div>
<div class="line">                                      3,    <span class="comment">/* aggregation_limit (default 3) */</span></div>
<div class="line">                                      0,    <span class="comment">/* coarsening_type (default 0) */</span></div>
<div class="line">                                      10,   <span class="comment">/* n_max_levels (default 25) */</span></div>
<div class="line">                                      30,   <span class="comment">/* min_g_cells (default 30) */</span></div>
<div class="line">                                      0.95, <span class="comment">/* P0P1 relaxation (default 0.95) */</span></div>
<div class="line">                                      20);  <span class="comment">/* postprocessing (default 0) */</span></div>
<div class="line"></div>
<div class="line">  <a class="code" href="cs__multigrid_8c.html#aa3fcf31a4edfc5d849804b9e0b137c3e">cs_multigrid_set_solver_options</a></div>
<div class="line">    (mg,</div>
<div class="line">     <a class="code" href="cs__sles__it_8h.html#ade7660f2d21b046b7883ae7ae454d535ad134cd09c239222a44d170d51921fe51">CS_SLES_JACOBI</a>, <span class="comment">/* descent smoother type (default: CS_SLES_PCG) */</span></div>
<div class="line">     <a class="code" href="cs__sles__it_8h.html#ade7660f2d21b046b7883ae7ae454d535ad134cd09c239222a44d170d51921fe51">CS_SLES_JACOBI</a>, <span class="comment">/* ascent smoother type (default: CS_SLES_PCG) */</span></div>
<div class="line">     <a class="code" href="cs__sles__it_8h.html#ade7660f2d21b046b7883ae7ae454d535aa2075b9ac16aa69eff976ad9115f5f90">CS_SLES_PCG</a>,    <span class="comment">/* coarse solver type (default: CS_SLES_PCG) */</span></div>
<div class="line">     50,             <span class="comment">/* n max cycles (default 100) */</span></div>
<div class="line">     5,              <span class="comment">/* n max iter for descent (default 10) */</span></div>
<div class="line">     5,              <span class="comment">/* n max iter for asscent (default 10) */</span></div>
<div class="line">     1000,           <span class="comment">/* n max iter coarse solver (default 10000) */</span></div>
<div class="line">     0,              <span class="comment">/* polynomial precond. degree descent (default 0) */</span></div>
<div class="line">     0,              <span class="comment">/* polynomial precond. degree ascent (default 0) */</span></div>
<div class="line">     1,              <span class="comment">/* polynomial precond. degree coarse (default 0) */</span></div>
<div class="line">     -1.0,           <span class="comment">/* precision multiplier descent (&lt; 0 forces max iters) */</span></div>
<div class="line">     -1.0,           <span class="comment">/* precision multiplier ascent (&lt; 0 forces max iters) */</span></div>
<div class="line">     0.1);           <span class="comment">/* requested precision multiplier coarse (default 1) */</span></div>
</div><!-- fragment --> <h2><a class="anchor" id="cs_user_parameters_h_sles_mg_parall"></a>
Multigrid parallel settings</h2>
<p>In parallel, grids may optionally be merged across neigboring ranks when their local size becomes too small. This tends to deepen the grid hierarchy, as some parallel rank boundaries are removed. Depending on the architecture and processor/network performance ratios, this may increase or decrease performance.</p>
<div class="fragment"><div class="line">  <a class="code" href="cs__grid_8c.html#a5efcaed79547e815b3d42b73adec88db">cs_grid_set_merge_options</a>(4,   <span class="comment">/* # of ranks merged at a time */</span></div>
<div class="line">                            300, <span class="comment">/* mean # of cells under which we merge */</span></div>
<div class="line">                            500, <span class="comment">/* global # of cells under which we merge */</span></div>
<div class="line">                            1);  <span class="comment">/* # of ranks under which we do not merge */</span></div>
</div><!-- fragment --> <h2><a class="anchor" id="cs_user_parameters_h_sles_rad_dom"></a>
Example: DOM radiation settings</h2>
<p>For DOM radiation models, 1 solver is assigned for each direction this allows using a specific ordering for each direction for the default Block Gauss-Seidel solver.</p>
<p>The example below shows how to set a non-default linear solver for DOM radiation. Here, we assume a quadrature with 32 directions is used (if more solvers than directions are specified, the extra definitions will be unused, but this causes no further issues).</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 32; i++) {</div>
<div class="line">    <span class="keywordtype">char</span> name[16];</div>
<div class="line">    sprintf(name, <span class="stringliteral">&quot;radiation_%03d&quot;</span>, i+1);</div>
<div class="line">    <a class="code" href="cs__sles__it_8c.html#a64c4f431048a0436cf67314c01883fdc">cs_sles_it_define</a>(-1,</div>
<div class="line">                      name,</div>
<div class="line">                      <a class="code" href="cs__sles__it_8h.html#ade7660f2d21b046b7883ae7ae454d535ad134cd09c239222a44d170d51921fe51">CS_SLES_JACOBI</a>,</div>
<div class="line">                      0,      <span class="comment">/* poly_degree */</span></div>
<div class="line">                      1000);  <span class="comment">/* n_max_iter */</span></div>
<div class="line"></div>
<div class="line">  }</div>
</div><!-- fragment --> <h1><a class="anchor" id="cs_user_parameters_h_cs_user_moments"></a>
Time moment related options</h1>
<p>Code_Saturne allows the calculation of temporal means or variances, either of expressions evaluated through a user function, or of expressions of the type <img class="formulaInl" alt="$<f_1*f_2...*f_n>$" src="form_551.png"/>. The variables may be fields or field components. This is done calling either through the GUI, or in the user function <a class="el" href="cs__user__parameters_8c.html#a6f112eebdd6f3295e884eb4b804ab033">cs_user_time_moments</a>. Each temporal mean is declared using either <a class="el" href="cs__time__moment_8h.html#ab31f9d215a3a0ddc72d0af59c802d939">cs_time_moment_define_by_func</a>, or <a class="el" href="cs__time__moment_8h.html#a9c4ceaf8666ccadb87a8997847497b27">cs_time_moment_define_by_field_ids</a>.</p>
<p>For each time moment, a starting time step or value is defined. If the starting time step number is negative, the time value is used instead.</p>
<p>The moment values are stored as fields, and updated at each time step, using recursive formulas. Before the matching moment computation starting time step, a moment's values are uniformly 0. For visualization an interpretation reasons, only fields of dimension 1, 3, 6, or 9 (scalars, vectors, or tensors of rank 2) are allowed, so moment definitions not matching this constraint should be split.</p>
<p>To count defined moments, use the <a class="el" href="cs__time__moment_8h.html#a52d769bbb79eb77032940096bb5b202a">cs_time_moment_n_moments</a> function, whether from Fortran or C. To access the matching fields, use <a class="el" href="interfacecs__c__bindings_1_1time__moment__field__id.html">time_moment_field_id</a> in Fortran, or <a class="el" href="cs__time__moment_8h.html#ac46810a89d670799ae7885568a6a137f">cs_time_moment_get_field</a> in C.</p>
<h1><a class="anchor" id="cs_user_parameters_h_examples"></a>
Examples</h1>
<h2><a class="anchor" id="cs_user_parameters_h_example_1"></a>
Example 1</h2>
<p>In the following example, we define a moment for the mean velocity. All components are used (component -1 means all components), so the moment is a vector.</p>
<div class="fragment"><div class="line">    <span class="keywordtype">int</span> moment_f_id[] = {<a class="code" href="cs__field__pointer_8h.html#ae1781f0372dce86ddbc097c119dfd028">CS_F_</a>(<a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00a63f235d4a03b00a5e43f0bfa785c853d">u</a>)-&gt;id};</div>
<div class="line">    <span class="keywordtype">int</span> moment_c_id[] = {-1};</div>
<div class="line">    <span class="keywordtype">int</span> n_fields = 1;</div>
<div class="line">    <a class="code" href="cs__time__moment_8c.html#a9c4ceaf8666ccadb87a8997847497b27">cs_time_moment_define_by_field_ids</a>(<span class="stringliteral">&quot;U_mean&quot;</span>,</div>
<div class="line">                                       n_fields,</div>
<div class="line">                                       moment_f_id,</div>
<div class="line">                                       moment_c_id,</div>
<div class="line">                                       <a class="code" href="cs__time__moment_8h.html#a9ca36c5a5924d6b07c864aeb5cc00658aa4f5b00568dec73143b19cf4d1b588ae">CS_TIME_MOMENT_MEAN</a>,</div>
<div class="line">                                       1000, <span class="comment">/* nt_start */</span></div>
<div class="line">                                       -1,   <span class="comment">/* t_start */</span></div>
<div class="line">                                       <a class="code" href="cs__time__moment_8h.html#a9b29da511199ee76d20b74689a5e051aa2add1559958d728b6e923ccb026abf05">CS_TIME_MOMENT_RESTART_AUTO</a>,</div>
<div class="line">                                       NULL);</div>
</div><!-- fragment --> <h2><a class="anchor" id="cs_user_parameters_h_example_2"></a>
Example 2</h2>
<p>In the next example, we multiply the expression by the density. As the density is of dimension 1, and the velocity of dimension 3, the resulting moment is of dimension 3.</p>
<div class="fragment"><div class="line">    <span class="keywordtype">int</span> moment_f_id[] = {<a class="code" href="cs__field__pointer_8h.html#ae1781f0372dce86ddbc097c119dfd028">CS_F_</a>(<a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00aa714b1d1f527388389cbff9365821f2a">rho</a>)-&gt;id, <a class="code" href="cs__field__pointer_8h.html#ae1781f0372dce86ddbc097c119dfd028">CS_F_</a>(<a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00a63f235d4a03b00a5e43f0bfa785c853d">u</a>)-&gt;id};</div>
<div class="line">    <span class="keywordtype">int</span> moment_c_id[] = {-1, -1};</div>
<div class="line">    <span class="keywordtype">int</span> n_fields = 2;</div>
<div class="line">    <a class="code" href="cs__time__moment_8c.html#a9c4ceaf8666ccadb87a8997847497b27">cs_time_moment_define_by_field_ids</a>(<span class="stringliteral">&quot;U_mean&quot;</span>,</div>
<div class="line">                                       n_fields,</div>
<div class="line">                                       moment_f_id,</div>
<div class="line">                                       moment_c_id,</div>
<div class="line">                                       <a class="code" href="cs__time__moment_8h.html#a9ca36c5a5924d6b07c864aeb5cc00658aa4f5b00568dec73143b19cf4d1b588ae">CS_TIME_MOMENT_MEAN</a>,</div>
<div class="line">                                       1000, <span class="comment">/* nt_start */</span></div>
<div class="line">                                       -1,   <span class="comment">/* t_start */</span></div>
<div class="line">                                       <a class="code" href="cs__time__moment_8h.html#a9b29da511199ee76d20b74689a5e051aa2add1559958d728b6e923ccb026abf05">CS_TIME_MOMENT_RESTART_AUTO</a>,</div>
<div class="line">                                       NULL);</div>
</div><!-- fragment --> <h2><a class="anchor" id="cs_user_parameters_h_example_3"></a>
Example 3</h2>
<p>In the next example, we define a product of several field components, all of dimension 1, as we consider only the x and y components of the velocity; for the density, we cas use either component 0 or -1 (all), since the field is scalar.</p>
<p>This moment's computation is also restarted at each time step.</p>
<div class="fragment"><div class="line">    <span class="keywordtype">int</span> moment_f_id[] = {<a class="code" href="cs__field__pointer_8h.html#ae1781f0372dce86ddbc097c119dfd028">CS_F_</a>(<a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00aa714b1d1f527388389cbff9365821f2a">rho</a>)-&gt;id, <a class="code" href="cs__field__pointer_8h.html#ae1781f0372dce86ddbc097c119dfd028">CS_F_</a>(<a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00a63f235d4a03b00a5e43f0bfa785c853d">u</a>)-&gt;id, <a class="code" href="cs__field__pointer_8h.html#ae1781f0372dce86ddbc097c119dfd028">CS_F_</a>(<a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00a63f235d4a03b00a5e43f0bfa785c853d">u</a>)-&gt;id};</div>
<div class="line">    <span class="keywordtype">int</span> moment_c_id[] = {-1, 0, 1};</div>
<div class="line">    <span class="keywordtype">int</span> n_fields = 3;</div>
<div class="line">    <a class="code" href="cs__time__moment_8c.html#a9c4ceaf8666ccadb87a8997847497b27">cs_time_moment_define_by_field_ids</a>(<span class="stringliteral">&quot;rho_u_v_mean&quot;</span>,</div>
<div class="line">                                       n_fields,</div>
<div class="line">                                       moment_f_id,</div>
<div class="line">                                       moment_c_id,</div>
<div class="line">                                       <a class="code" href="cs__time__moment_8h.html#a9ca36c5a5924d6b07c864aeb5cc00658aa4f5b00568dec73143b19cf4d1b588ae">CS_TIME_MOMENT_MEAN</a>,</div>
<div class="line">                                       -1,     <span class="comment">/* nt_start */</span></div>
<div class="line">                                       20.0,   <span class="comment">/* t_start */</span></div>
<div class="line">                                       <a class="code" href="cs__time__moment_8h.html#a9b29da511199ee76d20b74689a5e051aa56a706a9817cc3f47fa70258fce5fd16">CS_TIME_MOMENT_RESTART_RESET</a>,</div>
<div class="line">                                       NULL);</div>
</div><!-- fragment --> <h2><a class="anchor" id="cs_user_parameters_h_example_4"></a>
Example 4</h2>
<p>This next example illustrates the use of user-defined functions to evaluate expressions. Here, we compute the moment of the sum ot two variables (which obviously cannot be expressed as a product), so we first need to define an appropriate function, matching the signature of a <a class="el" href="cs__time__moment_8h.html#a07fc7e9fa131dce9474f3e3e94cc930e">cs_time_moment_data_t</a> function. We can name that function as we choose, so naming for clarity is recommmended. Note that in this case, the input argument is not used. This argument may be useful to pass data to the function, or distinguish between calls to a same function.</p>
<p>Note also that we compute both means and variances here.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">_simple_data_sum(<span class="keyword">const</span> <span class="keywordtype">void</span>  *input,</div>
<div class="line">                 <a class="code" href="cs__defs_8h.html#a3fd4659f2193f1213c774e0ba74c3537">cs_real_t</a>   *vals)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> location_id = <a class="code" href="cs__mesh__location_8h.html#a22064299f8a2e48cf0ac92e5a6f3c40fa400805bf7d4cd4f423bab17d7b9c2139">CS_MESH_LOCATION_CELLS</a>;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="cs__defs_8h.html#acb21fc5ae78909cb0493d2dbffade321">cs_lnum_t</a> n_elts = <a class="code" href="cs__mesh__location_8c.html#a27f24ae7ce67088986ad1ea7e2e78858">cs_mesh_location_get_n_elts</a>(location_id)[0];</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="cs__defs_8h.html#a3fd4659f2193f1213c774e0ba74c3537">cs_real_t</a> *s1 = <a class="code" href="cs__field_8c.html#af0f0e55c320fdf7aa435797008e869a2">cs_field_by_name</a>(<span class="stringliteral">&quot;species_1&quot;</span>)-&gt;<a class="code" href="structcs__field__t.html#acb906433e1289aa1c251dc5057746a88">val</a>;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="cs__defs_8h.html#a3fd4659f2193f1213c774e0ba74c3537">cs_real_t</a> *s2 = <a class="code" href="cs__field_8c.html#af0f0e55c320fdf7aa435797008e869a2">cs_field_by_name</a>(<span class="stringliteral">&quot;species_2&quot;</span>)-&gt;<a class="code" href="structcs__field__t.html#acb906433e1289aa1c251dc5057746a88">val</a>;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (<a class="code" href="cs__defs_8h.html#acb21fc5ae78909cb0493d2dbffade321">cs_lnum_t</a> i = 0; i &lt; n_elts; i++) {</div>
<div class="line">    vals[i] = s1[i] + s2[i];</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p> In <a class="el" href="cs__user__parameters_8c.html#a6f112eebdd6f3295e884eb4b804ab033">cs_user_time_moments</a>, we can not assign that function to a moments definition:</p>
<div class="fragment"><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *sum_comp_name[] = {<span class="stringliteral">&quot;species_sum_mean&quot;</span>, <span class="stringliteral">&quot;species_sum_variance&quot;</span>};</div>
<div class="line">    <a class="code" href="cs__time__moment_8h.html#a9ca36c5a5924d6b07c864aeb5cc00658">cs_time_moment_type_t</a> m_type[] = {<a class="code" href="cs__time__moment_8h.html#a9ca36c5a5924d6b07c864aeb5cc00658aa4f5b00568dec73143b19cf4d1b588ae">CS_TIME_MOMENT_MEAN</a>,</div>
<div class="line">                                      <a class="code" href="cs__time__moment_8h.html#a9ca36c5a5924d6b07c864aeb5cc00658a33167888ee40fb874d8a65d0508f1820">CS_TIME_MOMENT_VARIANCE</a>};</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 2; i++) {</div>
<div class="line">      <a class="code" href="cs__time__moment_8c.html#ab31f9d215a3a0ddc72d0af59c802d939">cs_time_moment_define_by_func</a>(sum_comp_name[i],</div>
<div class="line">                                    <a class="code" href="cs__mesh__location_8h.html#a22064299f8a2e48cf0ac92e5a6f3c40fa400805bf7d4cd4f423bab17d7b9c2139">CS_MESH_LOCATION_CELLS</a>,</div>
<div class="line">                                    1,                      <span class="comment">/* field dimension */</span></div>
<div class="line">                                    _simple_data_sum,       <span class="comment">/* data_func */</span></div>
<div class="line">                                    NULL,                   <span class="comment">/* data_input */</span></div>
<div class="line">                                    NULL,                   <span class="comment">/* w_data_func */</span></div>
<div class="line">                                    NULL,                   <span class="comment">/* w_data_input */</span></div>
<div class="line">                                    m_type[i],</div>
<div class="line">                                    1000,                   <span class="comment">/* nt_start */</span></div>
<div class="line">                                    -1,                     <span class="comment">/* t_start */</span></div>
<div class="line">                                    <a class="code" href="cs__time__moment_8h.html#a9b29da511199ee76d20b74689a5e051aa2add1559958d728b6e923ccb026abf05">CS_TIME_MOMENT_RESTART_AUTO</a>,</div>
<div class="line">                                    NULL);</div>
<div class="line">    }</div>
</div><!-- fragment --> <h2><a class="anchor" id="cs_user_parameters_h_example_5"></a>
Example 5</h2>
<p>In this last example, we compute components of the mean velocity in the case of a rotating mesh. As the mesh orientation changes at each time step, it is necessary to compensate for this rotation when computing the mean, relative to a given mesh position. When using the matching moment, it will also be necessary to account for the mesh position.</p>
<p>Here, the same function will be called for each component, so an input array is defined, with a different key (here a simple character) used for each call.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">_velocity_moment_data(<span class="keyword">const</span> <span class="keywordtype">void</span>  *input,</div>
<div class="line">                      <a class="code" href="cs__defs_8h.html#a3fd4659f2193f1213c774e0ba74c3537">cs_real_t</a>   *vals)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> key = *((<span class="keyword">const</span> <span class="keywordtype">char</span> *)input);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> location_id = <a class="code" href="cs__mesh__location_8h.html#a22064299f8a2e48cf0ac92e5a6f3c40fa400805bf7d4cd4f423bab17d7b9c2139">CS_MESH_LOCATION_CELLS</a>;</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="cs__defs_8h.html#acb21fc5ae78909cb0493d2dbffade321">cs_lnum_t</a> n_elts = <a class="code" href="cs__mesh__location_8c.html#a27f24ae7ce67088986ad1ea7e2e78858">cs_mesh_location_get_n_elts</a>(location_id)[0];</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="cs__defs_8h.html#a8d27bb24a82afd4586c0059c69172009">cs_real_3_t</a> *vel = (<span class="keyword">const</span> <a class="code" href="cs__defs_8h.html#a8d27bb24a82afd4586c0059c69172009">cs_real_3_t</a> *)(<a class="code" href="cs__field__pointer_8h.html#ae1781f0372dce86ddbc097c119dfd028">CS_F_</a>(<a class="code" href="cs__field__pointer_8h.html#a8847cc7e9a0af792d5b3087efa1d9e00a63f235d4a03b00a5e43f0bfa785c853d">u</a>)-&gt;val);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="cs__defs_8h.html#a8d27bb24a82afd4586c0059c69172009">cs_real_3_t</a>  *<a class="code" href="cs__defs_8h.html#a080abdcb9c02438f1cd2bb707af25af8">restrict</a> cell_cen</div>
<div class="line">    = (<span class="keyword">const</span> <a class="code" href="cs__defs_8h.html#a8d27bb24a82afd4586c0059c69172009">cs_real_3_t</a> *<a class="code" href="cs__defs_8h.html#a080abdcb9c02438f1cd2bb707af25af8">restrict</a>)<a class="code" href="cs__mesh__quantities_8h.html#afa2af6f0cc4c45284529ffcb8f90df8c">cs_glob_mesh_quantities</a>-&gt;<a class="code" href="structcs__mesh__quantities__t.html#ac6dcd8bcee7837ffac50f0ea3cdc4fb4">cell_cen</a>;</div>
<div class="line"></div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structcs__rotation__t.html">cs_rotation_t</a> *rot = <a class="code" href="cs__rotation_8h.html#a23fd936fc765a743b323900f70b45ec4">cs_glob_rotation</a>;</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">double</span> omgnrm = fabs(rot-&gt;omega);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Axial, tangential and radial unit vectors */</span></div>
<div class="line"></div>
<div class="line">  <a class="code" href="cs__defs_8h.html#a8d27bb24a82afd4586c0059c69172009">cs_real_3_t</a> e_ax = {rot-&gt;axis[0], rot-&gt;axis[1], rot-&gt;axis[2]};</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (<a class="code" href="cs__defs_8h.html#acb21fc5ae78909cb0493d2dbffade321">cs_lnum_t</a> i = 0; i &lt; n_elts; i++) {</div>
<div class="line"></div>
<div class="line">    <a class="code" href="cs__defs_8h.html#a8d27bb24a82afd4586c0059c69172009">cs_real_3_t</a> e_th;</div>
<div class="line">    <a class="code" href="cs__rotation_8h.html#a67d5aead17809c99ba40ed4229207548">cs_rotation_velocity</a>(rot, cell_cen[i], e_th);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">double</span> xnrm = sqrt(<a class="code" href="cs__math_8h.html#a85647509d4120318caa49dd030b12be2">cs_math_3_square_norm</a>(e_th));</div>
<div class="line"></div>
<div class="line">    e_th[0] /= xnrm;</div>
<div class="line">    e_th[1] /= xnrm;</div>
<div class="line">    e_th[2] /= xnrm;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="cs__defs_8h.html#a8d27bb24a82afd4586c0059c69172009">cs_real_3_t</a> e_r;</div>
<div class="line">    <a class="code" href="cs__rotation_8h.html#a874848b90048807eade520b6d84292de">cs_rotation_coriolis_v</a>(rot, -1., e_th, e_r);</div>
<div class="line"></div>
<div class="line">    xnrm = sqrt(<a class="code" href="cs__math_8h.html#a85647509d4120318caa49dd030b12be2">cs_math_3_square_norm</a>(e_r));</div>
<div class="line"></div>
<div class="line">    e_r[0] /= xnrm;</div>
<div class="line">    e_r[1] /= xnrm;</div>
<div class="line">    e_r[2] /= xnrm;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Radius */</span></div>
<div class="line">    <a class="code" href="cs__defs_8h.html#a3fd4659f2193f1213c774e0ba74c3537">cs_real_t</a> xr = <a class="code" href="cs__math_8h.html#a238458faa55a1d61ecf53f498040ef11">cs_math_3_dot_product</a>(cell_cen[i], e_r);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Axial, tangential and radial components of velocity */</span></div>
<div class="line">    <a class="code" href="cs__defs_8h.html#a3fd4659f2193f1213c774e0ba74c3537">cs_real_t</a> xva = vel[i][0]*e_ax[0] + vel[i][1]*e_ax[1] + vel[i][2]*e_ax[2];</div>
<div class="line">    <a class="code" href="cs__defs_8h.html#a3fd4659f2193f1213c774e0ba74c3537">cs_real_t</a> xvt = vel[i][0]*e_th[0] + vel[i][1]*e_th[1] + vel[i][2]*e_th[2];</div>
<div class="line">    <a class="code" href="cs__defs_8h.html#a3fd4659f2193f1213c774e0ba74c3537">cs_real_t</a> xvr = vel[i][0]*e_r[0]  + vel[i][1]*e_r[1]  + vel[i][2]*e_r[2];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Entrainment velocity is removed */</span></div>
<div class="line">    xvt -= omgnrm*xr;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Store value */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (key == <span class="charliteral">&#39;r&#39;</span>)</div>
<div class="line">      vals[i] = xvr;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (key == <span class="charliteral">&#39;t&#39;</span>)</div>
<div class="line">      vals[i] = xvt;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (key == <span class="charliteral">&#39;a&#39;</span>)</div>
<div class="line">      vals[i] = xva;</div>
<div class="line"></div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p> Note that the input arrays must be accessible when updating moments at each time step, so the array of inputs is declared static in <a class="el" href="cs__user__parameters_8c.html#a6f112eebdd6f3295e884eb4b804ab033">cs_user_time_moments</a>. Fo more complex inputs, we would have an array of inputs here; in this simple case, we could pass a simple call id as the input, casting from point to integer.</p>
<div class="fragment"><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *vel_comp_name[] = {<span class="stringliteral">&quot;Wr_moy&quot;</span>, <span class="stringliteral">&quot;Wt,moy&quot;</span>, <span class="stringliteral">&quot;Wa_moy&quot;</span>};</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Data input must be &quot;static&quot; so it can be used in later calls */</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span> vel_comp_input[3] = {<span class="charliteral">&#39;r&#39;</span>, <span class="charliteral">&#39;t&#39;</span>, <span class="charliteral">&#39;a&#39;</span>};</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> comp_id = 0; comp_id &lt; 3; comp_id++)  {</div>
<div class="line">      <a class="code" href="cs__time__moment_8c.html#ab31f9d215a3a0ddc72d0af59c802d939">cs_time_moment_define_by_func</a>(vel_comp_name[comp_id],</div>
<div class="line">                                    <a class="code" href="cs__mesh__location_8h.html#a22064299f8a2e48cf0ac92e5a6f3c40fa400805bf7d4cd4f423bab17d7b9c2139">CS_MESH_LOCATION_CELLS</a>,</div>
<div class="line">                                    1,</div>
<div class="line">                                    _velocity_moment_data,       <span class="comment">/* data_func */</span></div>
<div class="line">                                    &amp;(vel_comp_input[comp_id]),  <span class="comment">/* data_input */</span></div>
<div class="line">                                    NULL,                        <span class="comment">/* w_data_func */</span></div>
<div class="line">                                    NULL,                        <span class="comment">/* w_data_input */</span></div>
<div class="line">                                    <a class="code" href="cs__time__moment_8h.html#a9ca36c5a5924d6b07c864aeb5cc00658aa4f5b00568dec73143b19cf4d1b588ae">CS_TIME_MOMENT_MEAN</a>,</div>
<div class="line">                                    74000,                       <span class="comment">/* nt_start */</span></div>
<div class="line">                                    -1,                          <span class="comment">/* t_start */</span></div>
<div class="line">                                    <a class="code" href="cs__time__moment_8h.html#a9b29da511199ee76d20b74689a5e051aa2add1559958d728b6e923ccb026abf05">CS_TIME_MOMENT_RESTART_AUTO</a>,</div>
<div class="line">                                    NULL);</div>
<div class="line">    }</div>
</div><!-- fragment --></div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Apr 6 2016 17:20:36 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
