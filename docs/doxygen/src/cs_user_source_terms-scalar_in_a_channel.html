<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>Examples of data settings for source terms with scalar in a channel (cs_user_source_terms-scalar_in_a_channel.f90)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="icon.png"/></td>
    <td style="padding-left: 0.5em;">
    <div id="projectbrief">programmer&#39;s documentation</div>
    </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="cs_user_examples.html"><span>User&#160;examples</span></a></li>
      <li><a href="cs_var_dico.html"><span>Fortran-C&#160;naming&#160;reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="cs_user_examples.html">User examples</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Examples of data settings for source terms with scalar in a channel (cs_user_source_terms-scalar_in_a_channel.f90) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Additional right-hand side source terms for scalar equations (user scalars and specific physics scalars) with <a class="el" href="cs__user__source__terms_8f90.html#ac372efcdabb75f7ae0755c8e39034607">ustssc</a> subroutine.</p>
<h1><a class="anchor" id="usa_scal_channel"></a>
Usage</h1>
<p>The routine is called for each scalar, user or specific physisc. It is therefore necessary to test the value of the scalar number iscal to separate the treatments of the different scalars <code>(if (iscal.eq.p) then ....)</code>.</p>
<p>The additional source term is decomposed into an explicit part <img class="formulaInl" alt="$(crvexp)$" src="form_571.png"/> and an implicit part <img class="formulaInl" alt="$(crvimp)$" src="form_572.png"/> that must be provided here. The resulting equation solved by the code for a scalar <img class="formulaInl" alt="$f$" src="form_573.png"/> is:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[\rho \norm{\vol{\celli}} \frac{df}{dt} + .... = crvimp \cdot f + crvexp\]" src="form_574.png"/>
</p>
<dl class="section note"><dt>Note</dt><dd><img class="formulaInl" alt="$ crvexp $" src="form_575.png"/> and <img class="formulaInl" alt="$ crvimp$" src="form_576.png"/> are defined after the Finite Volume integration over the cells, so they include the <img class="formulaInl" alt="$\norm{\vol{\celli}}$" src="form_577.png"/> term. More precisely:<ul>
<li><img class="formulaInl" alt="$ crvexp$" src="form_578.png"/> is expressed in <img class="formulaInl" alt="$ kg\cdot [scal]\cdot s^{-1}$" src="form_579.png"/>, where <img class="formulaInl" alt="$ [scal]$" src="form_580.png"/> is the unit of the scalar</li>
<li><img class="formulaInl" alt="$crvimp$" src="form_581.png"/> is expressed in <img class="formulaInl" alt="$kg \cdot s^{-1} $" src="form_582.png"/></li>
</ul>
</dd></dl>
<p>The <img class="formulaInl" alt="$ crvexp $" src="form_575.png"/> and <img class="formulaInl" alt="$ crvimp $" src="form_583.png"/> arrays are already initialized to 0 before entering the the routine. It is not needed to do it in the routine (waste of CPU time).</p>
<p>For stability reasons, <code>Code_Saturne</code> will not add <code>-crvimp</code> directly to the diagonal of the matrix, but <code>Max</code>(-crvimp,0). This way, the <code>crvimp</code> term is treated implicitely only if it strengthens the diagonal of the matrix. However, when using the second-order in time scheme, this limitation cannot be done anymore and <code>-crvimp</code> is added directly. The user should therefore test the negativity of <code>crvimp</code> by himself.</p>
<p>When using the second-order in time scheme, one should supply:</p><ul>
<li><img class="formulaInl" alt="$ crvexp $" src="form_575.png"/> at time n</li>
<li><img class="formulaInl" alt="$ crvimp $" src="form_583.png"/> at time n+1/2</li>
</ul>
<p>The selection of cells where to apply the source terms is based on a getcel command. For more info on the syntax of the getcel command, refer to the user manual or to the comments on the similar command getfbr in the routine <a class="el" href="cs__user__boundary__conditions_8f90.html#acecf82910f8035f38ed401e5f7dfcda0">cs_user_boundary_conditions</a>.</p>
<dl class="section warning"><dt>Warning</dt><dd>If scalar is the temperature, the resulting equation solved by the code is:</dd></dl>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[\rho C_p \norm{\vol{\celli}} \frac{dT}{dt} + .... = crvimp \cdot T + crvexp\]" src="form_584.png"/>
</p>
<dl class="section note"><dt>Note</dt><dd><img class="formulaInl" alt="$ crvexp $" src="form_575.png"/> and <img class="formulaInl" alt="$ crvimp $" src="form_583.png"/> are defined after the Finite Volume integration over the cells, so they include the <img class="formulaInl" alt="$\norm{\vol{\celli}}$" src="form_577.png"/> term. More precisely:<ul>
<li><img class="formulaInl" alt="$ crvexp $" src="form_575.png"/> is expressed in <img class="formulaInl" alt="$W$" src="form_585.png"/></li>
<li><img class="formulaInl" alt="$ crvimp $" src="form_583.png"/> is expressed in <img class="formulaInl" alt="$ W \cdot K^{-1}$" src="form_586.png"/></li>
</ul>
</dd></dl>
<h1><a class="anchor" id="steep_scalar_channel"></a>
Steep source terms</h1>
<p>In case of a complex, non-linear source term, say <img class="formulaInl" alt="$F(f)$" src="form_587.png"/>, for scalar <img class="formulaInl" alt="$f$" src="form_573.png"/>, the easiest method is to implement the source term explicitely.</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[\frac{df}{dt} = .... + F(f^{(n)})\]" src="form_588.png"/>
</p>
<p> where <img class="formulaInl" alt="$f^{(n)}$" src="form_589.png"/> is the value of <img class="formulaInl" alt="$f$" src="form_573.png"/> at time <img class="formulaInl" alt="$t^n$" src="form_590.png"/>, the beginning of the time step.</p>
<p>This yields :</p><ul>
<li><code>crvexp = volume*F(f(n))</code></li>
<li><code>crvimp = 0</code></li>
</ul>
<p>However, if the source term is potentially steep, this fully explicit method will probably generate instabilities. It is therefore wiser to partially implicit the term by writing:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[\frac{df}{dt} = .... + \frac{dF}{df} f^{(n+1)} - \frac{dF}{df} f^{(n)} + F(f^{(n)})\]" src="form_591.png"/>
</p>
<p>This yields:</p><ul>
<li><code>crvexp = volume*(F(f(n)) - dF/df*f(n)) </code></li>
<li><code>crvimp = volume*dF/df</code></li>
</ul>
<h1><a class="anchor" id="loc_var_scal"></a>
Local variables</h1>
<div class="fragment"><div class="line"><span class="comment">! Local variables</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">integer</span>          iel</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">double precision</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">pointer</span> :: imasfl</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">double precision</span>, <span class="keywordtype">dimension(:,:)</span>, <span class="keywordtype">pointer</span> :: vel</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">double precision</span> ubulk, surf, xx</div>
<div class="line"><span class="keywordtype">integer</span>          iflmas, ifac, nn</div>
<div class="line"><span class="keywordtype">double precision</span> ubulkm</div>
<div class="line"><span class="keyword">data</span>             ubulkm /0.d0/</div>
<div class="line"><span class="keywordtype">save</span>             ubulkm</div>
</div><!-- fragment --><h1><a class="anchor" id="body_scal"></a>
Body</h1>
<p>Initialization </p><div class="fragment"><div class="line">ubulk= 0.d0</div>
<div class="line">surf = 0.d0</div>
</div><!-- fragment --><p> Map field arrays </p><div class="fragment"><div class="line"><span class="comment">call field_get_val_v(ivarfl(iu), vel)</span></div>
<div class="line"></div>
<div class="line"><span class="comment">call field_get_key_int(ivarfl(iu), kimasf, iflmas)</span></div>
<div class="line"><span class="comment">call field_get_val_s(iflmas, imasfl)</span></div>
<div class="line"></div>
<div class="line">nn= 0</div>
<div class="line"><span class="keywordflow">do</span> ifac = 1, <a class="code" href="group__mesh.html#ga984b4f9c95dbef7c83f0dee8bf4168a1">nfac</a></div>
<div class="line">  xx=<a class="code" href="group__mesh.html#ga317093a6ef7c931e70440212f035c68a">cdgfac</a>(1,ifac)</div>
<div class="line">  <span class="keywordflow">if</span>(abs(xx).lt.1.d-5) <span class="keywordflow">then</span></div>
<div class="line">    nn = nn + 1</div>
<div class="line">    ubulk = ubulk + imasfl(ifac)</div>
<div class="line">    surf  = surf + <a class="code" href="group__mesh.html#ga0adb0172e56599d5adb6d65fa05503cc">surfac</a>(1,ifac)</div>
<div class="line">  <span class="keywordflow">endif</span></div>
<div class="line"><span class="keywordflow">enddo</span></div>
</div><!-- fragment --><p> Parallelism </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (<a class="code" href="group__parall.html#ga77fe56a9acf4fc4a56b5d5ab878b7d4f">irangp</a>.ge.0) <span class="keywordflow">then</span></div>
<div class="line">  call <a class="code" href="interfaceparall_1_1parsom.html#a424406b4b54d67ae738db5ab55be7119">parsom</a>(ubulk)</div>
<div class="line">  call <a class="code" href="interfaceparall_1_1parsom.html#a424406b4b54d67ae738db5ab55be7119">parsom</a>(surf)</div>
<div class="line"><span class="keywordflow">endif</span></div>
<div class="line"></div>
<div class="line">ubulk = abs(ubulk)/abs(surf)</div>
<div class="line">ubulk = max(ubulk,1d-12)</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">do</span> iel = 1, <a class="code" href="group__mesh.html#gab639b5ed89912ab852608e25d395a782">ncel</a></div>
<div class="line">  crvimp(iel) = 0.d0</div>
<div class="line">  crvexp(iel) = <a class="code" href="group__mesh.html#ga63281eee444c94c800bc957891033901">volume</a>(iel)*vel(1,iel)/ubulk</div>
<div class="line"><span class="keywordflow">enddo</span></div>
</div><!-- fragment --> <h2><a class="anchor" id="format_scal"></a>
Formats</h2>
<div class="fragment"><div class="line"> 1000 <span class="keyword">format</span>(<span class="stringliteral">&#39; User source terms for variable &#39;</span>,a8,/)</div>
</div><!-- fragment --> <h2><a class="anchor" id="end_scal"></a>
End</h2>
<div class="fragment"><div class="line"><span class="keywordflow">return</span></div>
<div class="line"><span class="keyword">end subroutine </span><a class="code" href="cs__user__source__terms_8f90.html#ac372efcdabb75f7ae0755c8e39034607">ustssc</a></div>
</div><!-- fragment --></div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Apr 6 2016 17:20:36 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
