<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>For transported scalar: ustssc subroutine</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="icon.png"/></td>
    <td style="padding-left: 0.5em;">
    <div id="projectbrief">programmer&#39;s documentation</div>
    </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="cs_user_examples.html"><span>User&#160;examples</span></a></li>
      <li><a href="cs_var_dico.html"><span>Fortran-C&#160;naming&#160;reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="cs_user_examples.html">User examples</a></li><li class="navelem"><a class="el" href="cs_user_source_terms.html">Examples of data settings for source terms (cs_user_source_terms.f90)</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">For transported scalar: ustssc subroutine </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The routine is called for each scalar, user or specific physisc. It is therefore necessary to test the value of the scalar number iscal to separate the treatments of the different scalars <code>(if (iscal.eq.p) then ....)</code>.</p>
<p>The additional source term is decomposed into an explicit part <img class="formulaInl" alt="$ (crvexp) $" src="form_606.png"/> and an implicit part <img class="formulaInl" alt="$ (crvimp) $" src="form_607.png"/> that must be provided here. The resulting equation solved by the code for a scalar <img class="formulaInl" alt="$f$" src="form_573.png"/> is:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \rho \norm{\vol{\celli}}\frac{df}{dt} + .... = crvimp \cdot f + crvexp \]" src="form_608.png"/>
</p>
<dl class="section note"><dt>Note</dt><dd>that <img class="formulaInl" alt="$ crvexp $" src="form_575.png"/> and <img class="formulaInl" alt="$ crvimp$" src="form_576.png"/> are defined after the Finite Volume integration over the cells, so they include the <img class="formulaInl" alt="$\norm{\vol{\celli}}$" src="form_577.png"/> term. More precisely:<ul>
<li><img class="formulaInl" alt="$ crvexp$" src="form_578.png"/> is expressed in <img class="formulaInl" alt="$ kg\cdot [scal] \cdot s^{-1} $" src="form_609.png"/> , where <img class="formulaInl" alt="$ [scal] $" src="form_610.png"/> is the unit of the scalar</li>
<li><img class="formulaInl" alt="$ crvimp$" src="form_576.png"/> is expressed in <img class="formulaInl" alt="$ kg \cdot s^{-1} $" src="form_611.png"/></li>
</ul>
</dd></dl>
<p>The <img class="formulaInl" alt="$ crvexp $" src="form_575.png"/> and <img class="formulaInl" alt="$ crvimp$" src="form_576.png"/> arrays are already initialized to 0 before entering the the routine. It is not needed to do it in the routine (waste of CPU time).</p>
<p>For stability reasons, <code>Code_Saturne</code> will not add <code>-crvimp</code> directly to the diagonal of the matrix, but <code> Max(-crvimp,0).</code> This way, the <code>crvimp</code> term is treated implicitely only if it strengthens the diagonal of the matrix. However, when using the second-order in time scheme, this limitation cannot be done anymore and <code>-crvimp</code> is added directly. The user should therefore test the negativity of <code>crvimp</code> by himself.</p>
<p>When using the second-order in time scheme, one should supply:</p><ul>
<li><code>crvexp</code> at time n</li>
<li><code>crvimp</code> at time n+1/2</li>
</ul>
<p>The selection of cells where to apply the source terms is based on a <a class="el" href="cs__selector__f2c_8f90.html#a38790c6fd34e3546eb4eb449224d6dcc">getcel</a> command. For more info on the syntax of the <a class="el" href="cs__selector__f2c_8f90.html#a38790c6fd34e3546eb4eb449224d6dcc">getcel</a> command, refer to the user manual or to the comments on the similar command getfbr in the routine <a class="el" href="cs__user__boundary__conditions_8f90.html#acecf82910f8035f38ed401e5f7dfcda0">cs_user_boundary_conditions</a>.</p>
<dl class="section warning"><dt>Warning</dt><dd>If the scalar is the temperature, the resulting equation solved by the code is:</dd></dl>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \rho C_p \norm{\vol{\celli}} \frac{dT}{dt} + .... = crvimp \cdot T + crvexp \]" src="form_612.png"/>
</p>
<dl class="section note"><dt>Note</dt><dd><img class="formulaInl" alt="$crvexp$" src="form_613.png"/> and <img class="formulaInl" alt="$ crvimp$" src="form_576.png"/> are defined after the Finite Volume integration over the cells, so they include the <img class="formulaInl" alt="$\norm{\vol{\celli}}$" src="form_577.png"/> term. More precisely:<ul>
<li><img class="formulaInl" alt="$crvexp$" src="form_613.png"/> is expressed in <img class="formulaInl" alt="$ W $" src="form_614.png"/></li>
<li><img class="formulaInl" alt="$crvimp$" src="form_581.png"/> is expressed in <img class="formulaInl" alt="$ W \cdot K^{-1} $" src="form_615.png"/></li>
</ul>
</dd></dl>
<h1><a class="anchor" id="steep"></a>
Steep source terms</h1>
<p>In case of a complex, non-linear source term, say <img class="formulaInl" alt="$ F(f) $" src="form_616.png"/>, for scalar <img class="formulaInl" alt="$ f $" src="form_617.png"/>, the easiest method is to implement the source term explicitely.</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \frac{df}{dt} = .... + F(f^{(n)}) \]" src="form_618.png"/>
</p>
<p> where <img class="formulaInl" alt="$ f^{(n)} $" src="form_619.png"/> is the value of <img class="formulaInl" alt="$f$" src="form_573.png"/> at time <img class="formulaInl" alt="$t^n$" src="form_590.png"/>, the beginning of the time step.</p>
<p>This yields :</p><ul>
<li><code> crvexp = volume*F(f(n)) </code></li>
<li><code> crvimp = 0 </code></li>
</ul>
<p>However, if the source term is potentially steep, this fully explicit method will probably generate instabilities. It is therefore wiser to partially implicit the term by writing:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \frac{df}{dt} = .... + \frac{dF}{df} f^{(n+1)} - \frac{dF}{df} f^{(n)} + F(f^{(n)}) \]" src="form_620.png"/>
</p>
<p>This yields:</p><ul>
<li><code> crvexp = volume*( F(f(n)) - dF/df*f(n) ) </code></li>
<li><code> crvimp = volume*dF/df </code></li>
</ul>
<h1><a class="anchor" id="loc_var2"></a>
Local variables</h1>
<div class="fragment"><div class="line"><span class="comment">! Local variables</span></div>
<div class="line"></div>
<div class="line"><span class="comment">character(len=80) :: chaine</span></div>
<div class="line"><span class="keywordtype">integer</span>          ivar, iiscvr,  iel</div>
<div class="line"><span class="keywordtype">integer</span>          ilelt, nlelt</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">double precision</span> tauf, prodf, voltf, pwatt</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">dimension(:)</span> :: lstelt</div>
<div class="line"><span class="keywordtype">double precision</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">pointer</span> ::  cpro_rom</div>
<div class="line"></div>
</div><!-- fragment --> <h2><a class="anchor" id="init_and_finit_2"></a>
Initialization and finalization</h2>
<p>The following initialization block needs to be added for the following examples: </p><div class="fragment"><div class="line"><span class="comment">! Allocate a temporary array for cells selection</span></div>
<div class="line"><span class="keyword">allocate</span>(lstelt(<a class="code" href="group__mesh.html#gab639b5ed89912ab852608e25d395a782">ncel</a>))</div>
</div><!-- fragment --><p> At the end of the subroutine, it is recommended to deallocate the work array:</p>
<div class="fragment"><div class="line"><span class="keyword">deallocate</span>(lstelt)</div>
</div><!-- fragment --><p> In theory Fortran 95 deallocates locally-allocated arrays automatically, but deallocating arrays in a symmetric manner to their alloacation is good pratice, and avoids using a different logic between C and Fortran.</p>
<p><b> Remaining initialization</b></p>
<p>Index number of the variable associated to scalar iscal</p>
<div class="fragment"><div class="line">ivar = <a class="code" href="group__main__variables.html#ga2307b4d54b829b3aeeddf6c1e4e1129f">isca</a>(iscal)</div>
</div><!-- fragment --><p> Name of the variable associated to scalar iscal</p>
<div class="fragment"><div class="line"><span class="comment">call field_get_label(ivarfl(ivar), chaine)</span></div>
</div><!-- fragment --><p> Indicator of variance scalars</p>
<ul>
<li>If <code> iscavr(iscal) = 0 </code>: the scalar <code>iscal</code> is not a variance</li>
<li>If <code> iscavr(iscal) &gt; 0 </code> and <code> iscavr(iscal) &lt; nscal + 1:</code> the scalar <code>iscal</code> is the variance of the scalar <code>iscavr(iscal)</code> </li>
</ul>
<p><br />
 </p><div class="fragment"><div class="line">iiscvr = <a class="code" href="classoptcal.html#aed351dba21c28be64123140cc3c849cb">iscavr</a>(iscal)</div>
</div><!-- fragment --><p> Density</p>
<div class="fragment"><div class="line"><span class="comment">call field_get_val_s(icrom, cpro_rom)</span></div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="group__entsor.html#ga24acc5de13a2c3d6d3d321a754820237">iwarni</a>(ivar).ge.1) <span class="keywordflow">then</span></div>
<div class="line">  <span class="keyword">write</span>(<a class="code" href="group__entsor.html#ga35356a73490ee90d10e4a96684169505">nfecra</a>,1000) chaine(1:8)</div>
<div class="line"><span class="keywordflow">endif</span></div>
</div><!-- fragment --> <h1><a class="anchor" id="examplesource_2_1"></a>
Example 1</h1>
<p>Example of arbitrary source term for the scalar f, 2nd scalar in the calculation.</p>
<p><img class="formulaInl" alt="$ S=A \cdot f+B $" src="form_621.png"/></p>
<p>appearing in the equation under the form</p>
<p><img class="formulaInl" alt="$ \rho \dfrac{df}{dt}=S \: \text{(+ regular other terms in the equation)} $" src="form_622.png"/> In the following example:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[A=-\frac{\rho}{\tau_f} \]" src="form_623.png"/>
</p>
 <p class="formulaDsp">
<img class="formulaDsp" alt="\[B=\rho \cdot prod_f \]" src="form_624.png"/>
</p>
<p>with:</p><ul>
<li>tauf = 10.d0 (in <img class="formulaInl" alt="$ s $" src="form_625.png"/>) (dissipation time for <img class="formulaInl" alt="$f$" src="form_573.png"/>)</li>
<li>prodf = 100.d0 (in <img class="formulaInl" alt="$ [f]\cdot s^{-1} $" src="form_626.png"/>) (production of <img class="formulaInl" alt="$f$" src="form_573.png"/> by unit of time)</li>
</ul>
<p>which yields:</p><ul>
<li><code> crvimp(iel) = volume(iel)*A = -volume(iel)*rho/tauf </code></li>
<li><code> crvexp(iem) = volume(iel)*B= volume(iel)*rho*prod_f </code></li>
</ul>
<h2><a class="anchor" id="bodysource2"></a>
Body</h2>
<p><b> Source term applied to second scalar</b></p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (iscal.eq.2) <span class="keywordflow">then</span></div>
<div class="line"></div>
<div class="line">   tauf  = 10.d0</div>
<div class="line">   prodf = 100.d0</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">do</span> iel = 1, <a class="code" href="group__mesh.html#gab639b5ed89912ab852608e25d395a782">ncel</a></div>
<div class="line">      crvimp(iel) = - <a class="code" href="group__mesh.html#ga63281eee444c94c800bc957891033901">volume</a>(iel)*cpro_rom(iel)/tauf</div>
<div class="line">   <span class="keywordflow">enddo</span></div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">do</span> iel = 1, <a class="code" href="group__mesh.html#gab639b5ed89912ab852608e25d395a782">ncel</a></div>
<div class="line">      crvexp(iel) =   <a class="code" href="group__mesh.html#ga63281eee444c94c800bc957891033901">volume</a>(iel)*cpro_rom(iel)*prodf</div>
<div class="line">   <span class="keywordflow">enddo</span></div>
<div class="line"></div>
<div class="line"><span class="keywordflow">endif</span></div>
</div><!-- fragment --> <h1><a class="anchor" id="examplesource2_2"></a>
Example 2</h1>
<p>Example of arbitrary volumic heat term in the equation for enthalpy h.</p>
<p>In the considered example, a uniform volumic source of heating is imposed in the cells with coordinate X in [0;1.2] and Y in [3.1;4].</p>
<p>The global heating power if <code>Pwatt</code> (in <img class="formulaInl" alt="$W$" src="form_585.png"/>) and the total volume of the selected cells is <code>volf</code> (in <img class="formulaInl" alt="$m^3$" src="form_627.png"/>).</p>
<p>This yields:</p><ul>
<li><code> crvimp(iel) = 0 </code></li>
<li><code> crvexp(iel) = volume(iel)* pwatt/volf </code></li>
</ul>
<h2><a class="anchor" id="end2"></a>
Body</h2>
<dl class="section warning"><dt>Warning</dt><dd>It is assumed here that the thermal scalar is an enthalpy. If the scalar is a temperature. PWatt does not need to be divided by <img class="formulaInl" alt="$ C_p $" src="form_3.png"/> because <img class="formulaInl" alt="$C_p$" src="form_628.png"/> is put outside thediffusion term and multiplied in the temperature equation as follows: <p class="formulaDsp">
<img class="formulaDsp" alt="\[ \rho C_p \norm{\vol{\celli}} \frac{dT}{dt} + ... = \norm{\vol{\celli}(iel)} \frac{pwatt}{voltf} \]" src="form_629.png"/>
</p>
</dd></dl>
<p>with <code> pwatt = 100.d0 </code></p>
<h2><a class="anchor" id="cs_user_st_3_cal_volf"></a>
Calculation of voltf</h2>
<div class="fragment"><div class="line">voltf  = 0.d0</div>
<div class="line">call <a class="code" href="cs__selector__f2c_8f90.html#a38790c6fd34e3546eb4eb449224d6dcc">getcel</a>(<span class="stringliteral">&#39;x &gt; 0.0 and x &lt; 1.2 and y &gt; 3.1 and &#39;</span>//               &amp;</div>
<div class="line">            <span class="stringliteral">&#39;y &lt; 4.0&#39;</span>, nlelt, lstelt)</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">do</span> ilelt = 1, nlelt</div>
<div class="line">  iel = lstelt(ilelt)</div>
<div class="line">  voltf = voltf + <a class="code" href="group__mesh.html#ga63281eee444c94c800bc957891033901">volume</a>(iel)</div>
<div class="line"><span class="keywordflow">enddo</span></div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="group__parall.html#ga77fe56a9acf4fc4a56b5d5ab878b7d4f">irangp</a>.ge.0) <span class="keywordflow">then</span></div>
<div class="line">  call <a class="code" href="interfaceparall_1_1parsom.html#a424406b4b54d67ae738db5ab55be7119">parsom</a>(voltf)</div>
<div class="line"><span class="keywordflow">endif</span></div>
</div><!-- fragment --> <h2><a class="anchor" id="cs_user_st_3_apply"></a>
Apply source term</h2>
<div class="fragment"><div class="line"><span class="keywordflow">do</span> ilelt = 1, nlelt</div>
<div class="line">  iel = lstelt(ilelt)</div>
<div class="line"><span class="comment">! No implicit source term</span></div>
<div class="line">  crvimp(iel) = 0.d0</div>
<div class="line"><span class="comment">! Explicit source term</span></div>
<div class="line">  crvexp(iel) = <a class="code" href="group__mesh.html#ga63281eee444c94c800bc957891033901">volume</a>(iel)*pwatt/voltf</div>
<div class="line"><span class="keywordflow">enddo</span></div>
</div><!-- fragment --></div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Apr 6 2016 17:20:36 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
